<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Performance Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
  background: #f5f5f5;
  padding: 20px;
}

.filters {
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
}

select {
  padding: 6px 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
}

.table-container {
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  overflow: hidden;
}

table {
  width: 100%;
  border-collapse: collapse;
}

thead {
  background: #f8f9fa;
  border-bottom: 2px solid #dee2e6;
}

th {
  padding: 12px 16px;
  text-align: left;
  font-weight: 600;
  font-size: 13px;
  color: #495057;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

td {
  padding: 16px;
  vertical-align: middle;
}

tbody tr {
  border-bottom: 1px solid #e9ecef;
}

tbody tr:hover {
  background-color: #f8f9fa;
}

.actual-value {
  font-size: 18px;
  font-weight: 600;
  display: block;
}

.plan-value {
  font-size: 11px;
  color: #6c757d;
  display: block;
}

.variance {
  font-size: 12px;
  font-weight: 500;
  display: block;
}

.variance.positive { color: #00C853; }
.variance.negative { color: #FF5252; }
.variance.neutral { color: #9E9E9E; }

.roas-cell.good {
  background: linear-gradient(135deg, #4CAF50, #66BB6A);
  color: white;
}

.roas-cell.average {
  background: linear-gradient(135deg, #FFC107, #FFD54F);
  color: #333;
}

.roas-cell.poor {
  background: linear-gradient(135deg, #FF5252, #FF7043);
  color: white;
}

.total-row {
  background: #f8f9fa;
  font-weight: 600;
  border-top: 2px solid #dee2e6;
}

.currency::before { content: '₹'; }

@media (max-width: 768px) {
  th, td { padding: 10px 8px; font-size: 12px; }
  .actual-value { font-size: 16px; }
}
</style>
</head>
<body>

<div class="filters">
  <label>View:</label>
  <select id="viewFilter">
    <option value="cumulative">Cumulative</option>
    <option value="monthly">Monthly</option>
  </select>

  <label id="monthFilterContainer" style="display:none;">Month:</label>
  <select id="monthFilter" style="display:none;"></select>
</div>

<div class="table-container">
  <table>
    <thead>
      <tr>
        <th>Course</th>
        <th>Leads</th>
        <th>Admissions</th>
        <th>Revenue</th>
        <th>P&amp;L</th>
        <th>Spend</th>
        <th>CPL</th>
        <th>CPA</th>
        <th>ROAS ⭐</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRS5Ky77_UNMTG7iCE8DfZmslDL0LvCQ-5IWYZjBZg7V6_7VobRhuuAr7tzz5Vv34m-EOPnDW26IsAR/pub?gid=0&single=true&output=csv";
let masterData = [];

function calculateVariance(actual, plan) {
  if (plan === 0) return 0;
  return ((actual - plan) / plan) * 100;
}

function formatVariance(variance) {
  const rounded = Math.round(variance * 10) / 10;
  if (variance > 0) return `<span class="variance positive">↗ +${rounded}%</span>`;
  if (variance < 0) return `<span class="variance negative">↘ ${rounded}%</span>`;
  return `<span class="variance neutral">↔ 0%</span>`;
}

function formatNumber(num) {
  return num.toLocaleString('en-IN');
}

function formatCurrency(num) {
  return `₹${num}k`;
}

function getROASClass(roas) {
  if (roas >= 3.5) return 'good';
  if (roas >= 3.0) return 'average';
  return 'poor';
}

function createMetricCell(actual, plan, isCurrency = false, isDecimal = false) {
  const variance = calculateVariance(actual, plan);
  let actualDisplay, planDisplay;
  if (isDecimal) {
    actualDisplay = actual.toFixed(1);
    planDisplay = plan.toFixed(1);
  } else if (isCurrency) {
    actualDisplay = formatCurrency(actual);
    planDisplay = formatCurrency(plan);
  } else {
    actualDisplay = formatNumber(actual);
    planDisplay = formatNumber(plan);
  }
  return `
    <div>
      <span class="actual-value">${actualDisplay}</span>
      <span class="plan-value">Plan: ${planDisplay}</span>
      ${formatVariance(variance)}
    </div>
  `;
}

async function fetchSheetData() {
  return new Promise((resolve, reject) => {
    Papa.parse(SHEET_URL, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: res => resolve(res.data),
      error: err => reject(err)
    });
  });
}

function cleanNumber(val) {
  if (!val || val === "#DIV/0!") return 0;
  const num = parseFloat(val.toString().replace(/[^\d.-]/g, ""));
  return isNaN(num) ? 0 : num;
}

function transformData(rows) {
  return rows.map(r => ({
    course: r["Course"] || "Unknown",
    month: r["Month"] || "Unknown",
    leads: { actual: cleanNumber(r["Leads_Actual"]), plan: cleanNumber(r["Leads_Plan"]) },
    admissions: { actual: cleanNumber(r["Admissions_Actual"]), plan: cleanNumber(r["Admissions_Plan"]) },
    revenue: { actual: cleanNumber(r["Revenue_Actual"]), plan: cleanNumber(r["Revenue_Plan"]) },
    pl: { actual: cleanNumber(r["PL_Actual"]), plan: cleanNumber(r["PL_Plan"]) },
    spend: { actual: cleanNumber(r["Spend_Actual"]), plan: cleanNumber(r["Spend_Plan"]) },
    cpl: { actual: cleanNumber(r["CPL_Actual"]), plan: cleanNumber(r["CPL_Plan"]) },
    cpa: { actual: cleanNumber(r["CPA_Actual"]), plan: cleanNumber(r["CPA_Plan"]) },
    roas: { actual: cleanNumber(r["ROAS_Actual"]), plan: cleanNumber(r["ROAS_Plan"]) }
  }));
}

function renderTable(data) {
  const tbody = document.getElementById('tableBody');
  if (!data || data.length === 0) {
    tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;padding:20px;color:#777;">No data found</td></tr>`;
    return;
  }
  let html = '';
  const totals = {
    leads:{actual:0,plan:0}, admissions:{actual:0,plan:0}, revenue:{actual:0,plan:0},
    pl:{actual:0,plan:0}, spend:{actual:0,plan:0}, cpl:{actual:0,plan:0},
    cpa:{actual:0,plan:0}, roas:{actual:0,plan:0}
  };
  data.forEach(row => {
    const roasClass = getROASClass(row.roas.actual);
    html += `
      <tr>
        <td>${row.course}</td>
        <td>${createMetricCell(row.leads.actual, row.leads.plan)}</td>
        <td>${createMetricCell(row.admissions.actual, row.admissions.plan)}</td>
        <td>${createMetricCell(row.revenue.actual, row.revenue.plan, true)}</td>
        <td>${createMetricCell(row.pl.actual, row.pl.plan, true)}</td>
        <td>${createMetricCell(row.spend.actual, row.spend.plan, true)}</td>
        <td>${createMetricCell(row.cpl.actual, row.cpl.plan, true)}</td>
        <td>${createMetricCell(row.cpa.actual, row.cpa.plan, true)}</td>
        <td class="roas-cell ${roasClass}">
          ${createMetricCell(row.roas.actual, row.roas.plan, false, true)}
        </td>
      </tr>
    `;
    Object.keys(totals).forEach(key => {
      totals[key].actual += row[key].actual;
      totals[key].plan += row[key].plan;
    });
  });
  const rowCount = data.length;
  ['cpl','cpa','roas'].forEach(k=>{
    totals[k].actual /= rowCount;
    totals[k].plan /= rowCount;
  });
  const totalRoasClass = getROASClass(totals.roas.actual);
  html += `
    <tr class="total-row">
      <td>Total</td>
      <td>${createMetricCell(totals.leads.actual, totals.leads.plan)}</td>
      <td>${createMetricCell(totals.admissions.actual, totals.admissions.plan)}</td>
      <td>${createMetricCell(totals.revenue.actual, totals.revenue.plan, true)}</td>
      <td>${createMetricCell(totals.pl.actual, totals.pl.plan, true)}</td>
      <td>${createMetricCell(totals.spend.actual, totals.spend.plan, true)}</td>
      <td>${createMetricCell(totals.cpl.actual, totals.cpl.plan, true)}</td>
      <td>${createMetricCell(totals.cpa.actual, totals.cpa.plan, true)}</td>
      <td class="roas-cell ${totalRoasClass}">
        ${createMetricCell(totals.roas.actual, totals.roas.plan, false, true)}
      </td>
    </tr>`;
  tbody.innerHTML = html;
}

function filterData(view, month) {
  if (view === "cumulative") return masterData;
  if (view === "monthly") return masterData.filter(r => r.month === month);
  return [];
}

async function init() {
  const rawData = await fetchSheetData();
  masterData = transformData(rawData);

  const months = [...new Set(masterData.map(r => r.month))];
  const monthSelect = document.getElementById('monthFilter');
  monthSelect.innerHTML = months.map(m => `<option value="${m}">${m}</option>`).join("");

  handleFilterChange();
}

const viewFilter = document.getElementById('viewFilter');
const monthFilter = document.getElementById('monthFilter');
const monthFilterContainer = document.getElementById('monthFilterContainer');

viewFilter.addEventListener('change', handleFilterChange);
monthFilter.addEventListener('change', handleFilterChange);

function handleFilterChange() {
  const view = viewFilter.value;
  const month = monthFilter.value;
  if (view === "monthly") {
    monthFilter.style.display = "inline-block";
    monthFilterContainer.style.display = "inline-block";
  } else {
    monthFilter.style.display = "none";
    monthFilterContainer.style.display = "none";
  }
  renderTable(filterData(view, month));
}

init();
</script>
</body>
</html>
