<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Table</title>
    <style>
        * {margin:0; padding:0; box-sizing:border-box;}
        body {font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; background:#f5f5f5; padding:20px;}
        .filters {margin-bottom:20px; display:flex; gap:10px; align-items:center;}
        .table-container {background:white; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); overflow:hidden;}
        table {width:100%; border-collapse:collapse;}
        thead {background:#f8f9fa; border-bottom:2px solid #dee2e6;}
        th {padding:12px 16px; text-align:left; font-weight:600; font-size:13px; color:#495057; text-transform:uppercase; letter-spacing:0.5px;}
        th:first-child {padding-left:24px;}
        tbody tr {border-bottom:1px solid #e9ecef; transition: background-color 0.2s;}
        tbody tr:hover {background-color:#f8f9fa;}
        tbody tr:last-child {border-bottom:none;}
        td {padding:16px; vertical-align:middle;}
        td:first-child {padding-left:24px; font-weight:500; color:#212529;}
        .metric-cell {line-height:1.6;}
        .actual-value {font-size:18px; font-weight:600; color:#212529; display:block; margin-bottom:4px;}
        .plan-value {font-size:11px; color:#6c757d; display:block; margin-bottom:4px;}
        .variance {font-size:12px; font-weight:500; display:block;}
        .variance.positive {color:#00C853;}
        .variance.negative {color:#FF5252;}
        .variance.neutral {color:#9E9E9E;}
        .roas-cell {background:linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); font-weight:600; text-align:center;}
        .roas-cell.good {background:linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%); color:white;}
        .roas-cell.average {background:linear-gradient(135deg, #FFC107 0%, #FFD54F 100%); color:#333;}
        .roas-cell.poor {background:linear-gradient(135deg, #FF5252 0%, #FF7043 100%); color:white;}
        .total-row {background:#f8f9fa; font-weight:600; border-top:2px solid #dee2e6;}
        .total-row td {padding:18px 16px;}
        .currency::before {content:'₹';}
        @media (max-width:768px) {body{padding:10px;} th, td{padding:10px 8px;font-size:12px;} .actual-value{font-size:16px;}}
    </style>
</head>
<body>

    <!-- Filters -->
    <div class="filters">
        <label>
            View:
            <select id="viewFilter">
                <option value="cumulative">Cumulative Till Date</option>
                <option value="monthly">Monthly</option>
                <option value="weekly">Weekly</option>
            </select>
        </label>

        <label id="monthFilterContainer" style="display:none;">
            Month:
            <select id="monthFilter">
                <option value="January">January</option>
                <option value="February">February</option>
                <option value="March">March</option>
                <option value="April">April</option>
                <option value="May">May</option>
                <option value="June">June</option>
                <option value="July">July</option>
                <option value="August">August</option>
                <option value="September">September</option>
                <option value="October">October</option>
                <option value="November">November</option>
                <option value="December">December</option>
            </select>
        </label>
    </div>

    <!-- Table -->
    <div class="table-container">
        <table id="performanceTable">
            <thead>
                <tr>
                    <th>Course</th>
                    <th>Leads</th>
                    <th>Admissions</th>
                    <th>Revenue</th>
                    <th>P&L</th>
                    <th>Spend</th>
                    <th>CPL</th>
                    <th>CPA</th>
                    <th>ROAS ⭐</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- Data populated by JS -->
            </tbody>
        </table>
    </div>

<script>
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/<YOUR-SHEET-ID>/pub?gid=0&single=true&output=csv";

    async function fetchSheetData() {
        const response = await fetch(SHEET_URL);
        const text = await response.text();
        const rows = text.trim().split("\n").map(r => r.split(","));
        const headers = rows[0].map(h => h.trim());
        return rows.slice(1).map(r => {
            const row = {};
            headers.forEach((h,i)=>row[h]=r[i]?r[i].trim():"");
            return row;
        });
    }

    function transformData(sheetRows) {
        return sheetRows.map(r=>({
            course: r["Course"],
            month: r["Month"],
            date: r["Date"],
            leads:{actual:+r["Leads_Actual"], plan:+r["Leads_Plan"]},
            admissions:{actual:+r["Admissions_Actual"], plan:+r["Admissions_Plan"]},
            revenue:{actual:+r["Revenue_Actual"], plan:+r["Revenue_Plan"]},
            pl:{actual:+r["PL_Actual"], plan:+r["PL_Plan"]},
            spend:{actual:+r["Spend_Actual"], plan:+r["Spend_Plan"]},
            cpl:{actual:+r["CPL_Actual"], plan:+r["CPL_Plan"]},
            cpa:{actual:+r["CPA_Actual"], plan:+r["CPA_Plan"]},
            roas:{actual:+r["ROAS_Actual"], plan:+r["ROAS_Plan"]}
        }));
    }

    // Metric rendering functions
    function calculateVariance(actual, plan){ return plan===0?0:((actual-plan)/plan)*100; }
    function formatVariance(variance){const r=Math.round(variance*10)/10;return variance>0?`<span class="variance positive">↗ +${r}%</span>`:variance<0?`<span class="variance negative">↘ ${r}%</span>`:`<span class="variance neutral">↔ 0%</span>`;}
    function formatNumber(num){return num.toLocaleString('en-IN');}
    function formatCurrency(num){return `₹${num}k`;}
    function createMetricCell(actual, plan, isCurrency=false, isDecimal=false){
        const variance=calculateVariance(actual,plan);
        let actualDisplay,planDisplay;
        if(isDecimal){actualDisplay=actual.toFixed(1);planDisplay=plan.toFixed(1);}
        else if(isCurrency){actualDisplay=formatCurrency(actual);planDisplay=formatCurrency(plan);}
        else{actualDisplay=formatNumber(actual);planDisplay=formatNumber(plan);}
        return `<div class="metric-cell"><span class="actual-value">${actualDisplay}</span><span class="plan-value">Plan: ${planDisplay}</span>${formatVariance(variance)}</div>`;
    }
    function getROASClass(roas){if(roas>=3.5)return'good'; if(roas>=3.0)return'average'; return'poor';}

    function renderTable(data){
        const tbody=document.getElementById('tableBody');
        let html='';
        const totals={leads:{actual:0,plan:0},admissions:{actual:0,plan:0},revenue:{actual:0,plan:0},pl:{actual:0,plan:0},spend:{actual:0,plan:0},cpl:{actual:0,plan:0},cpa:{actual:0,plan:0},roas:{actual:0,plan:0}};
        data.forEach(row=>{
            const roasClass=getROASClass(row.roas.actual);
            html+=`<tr>
                <td>${row.course}</td>
                <td>${createMetricCell(row.leads.actual,row.leads.plan)}</td>
                <td>${createMetricCell(row.admissions.actual,row.admissions.plan)}</td>
                <td>${createMetricCell(row.revenue.actual,row.revenue.plan,true)}</td>
                <td>${createMetricCell(row.pl.actual,row.pl.plan,true)}</td>
                <td>${createMetricCell(row.spend.actual,row.spend.plan,true)}</td>
                <td>${createMetricCell(row.cpl.actual,row.cpl.plan,true)}</td>
                <td>${createMetricCell(row.cpa.actual,row.cpa.plan,true)}</td>
                <td class="roas-cell ${roasClass}">${createMetricCell(row.roas.actual,row.roas.plan,false,true)}</td>
            </tr>`;
            Object.keys(totals).forEach(k=>{totals[k].actual+=row[k].actual; totals[k].plan+=row[k].plan;});
        });
        const rowCount=data.length;
        ['cpl','cpa','roas'].forEach(k=>{totals[k].actual=Math.round(totals[k].actual/rowCount); totals[k].plan=Math.round(totals[k].plan/rowCount);});
        const totalRoasClass=getROASClass(totals.roas.actual/rowCount);
        html+=`<tr class="total-row">
            <td>Total</td>
            <td>${createMetricCell(totals.leads.actual,totals.leads.plan)}</td>
            <td>${createMetricCell(totals.admissions.actual,totals.admissions.plan)}</td>
            <td>${createMetricCell(totals.revenue.actual,totals.revenue.plan,true)}</td>
            <td>${createMetricCell(totals.pl.actual,totals.pl.plan,true)}</td>
            <td>${createMetricCell(totals.spend.actual,totals.spend.plan,true)}</td>
            <td>${createMetricCell(totals.cpl.actual,totals.cpl.plan,true)}</td>
            <td>${createMetricCell(totals.cpa.actual,totals.cpa.plan,true)}</td>
            <td class="roas-cell ${totalRoasClass}">${createMetricCell(totals.roas.actual/rowCount,totals.roas.plan/rowCount,false,true)}</td>
        </tr>`;
        tbody.innerHTML=html;
    }

    // =========================
    // Filter Logic
    // =========================
    const viewFilter=document.getElementById("viewFilter");
    const monthFilter=document.getElementById("monthFilter");
    const monthFilterContainer=document.getElementById("monthFilterContainer");

    viewFilter.addEventListener("change", handleFilterChange);
    monthFilter.addEventListener("change", handleFilterChange);

    let masterData=[];

    function handleFilterChange(){
        const view=viewFilter.value;
        const month=monthFilter.value;
        if(view==="monthly") monthFilterContainer.style.display="inline-block";
        else monthFilterContainer.style.display="none";
        const filteredData=filterData(masterData,view,month);
        renderTable(filteredData);
    }

    function filterData(data,view,month){
        if(view==="cumulative") return data;
        if(view==="monthly") return data.filter(r=>r.month?.toLowerCase()===month.toLowerCase());
        if(view==="weekly"){
            const today=new Date();
            const weekAgo=new Date(today); weekAgo.setDate(today.getDate()-7);
            return data.filter(r=>{const d=new Date(r.date); return d>=weekAgo && d<=today;});
        }
        return data;
    }

    async function init(){
        try{
            const sheetRows=await fetchSheetData();
            masterData=transformData(sheetRows);
            handleFilterChange();
        }catch(err){console.error("Error loading sheet data:",err);}
    }

    window.updateTableData=renderTable; // keep old function reference for compatibility
    init();
</script>
</body>
</html>
