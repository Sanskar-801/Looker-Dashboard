<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>University Performance Dashboard</title>
	<style>
		* { margin: 0; padding: 0; box-sizing: border-box; }
		body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; background: #f5f5f5; padding: 20px; }
		.dashboard-container { max-width: 1600px; margin: 0 auto; }

		.filters-section { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
		.filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end; }
		.filter-group { display: flex; flex-direction: column; }
		.filter-label { font-size: 12px; font-weight: 700; color: #111827; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.6px; }
		select { padding: 10px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px; color: #495057; background-color: white; cursor: pointer; transition: border-color 0.2s; }
		select:hover { border-color: #80bdff; }
		select:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
		.apply-button { padding: 10px 24px; background: #007bff; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; transition: background 0.2s; }
		.apply-button:hover { background: #0056b3; }
		.apply-button:active { transform: scale(0.98); }

		.loading { text-align: center; padding: 40px; color: #6c757d; }
		.error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
		.info-banner { background: #d1ecf1; color: #0c5460; padding: 12px 20px; border-radius: 6px; margin-bottom: 20px; font-size: 14px; }

		/* KPI Cards */
		.kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px; }
		.kpi-card { background: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 16px; }
		.kpi-title { font-size: 12px; font-weight: 900; color: #111827; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 8px; }
		.kpi-actual { font-size: 28px; font-weight: 800; color: #111827; margin-bottom: 4px; }
		.kpi-revised { font-size: 13px; font-weight: 600; color: #6b7280; margin-bottom: 10px; }
		.bullet-track { background: #e5e7eb; border-radius: 9999px; height: 10px; overflow: hidden; position: relative; }
		.bullet-fill { height: 100%; border-radius: 9999px; transition: width 0.4s ease; }
		.kpi-percent { font-size: 12px; font-weight: 800; margin-top: 8px; }
		.kpi-green { color: #065F46; }
		.kpi-red { color: #7F1D1D; }
		.fill-green { background: #10B981; }
		.fill-red { background: #EF4444; }

		/* Table */
		.table-container { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow-x: auto; }
		table { width: 100%; border-collapse: collapse; min-width: 1100px; }
		thead { background: #eef2ff; border-bottom: 3px solid #c7d2fe; position: sticky; top: 0; z-index: 10; }
		th { padding: 12px 16px; text-align: left; font-weight: 800; font-size: 13px; color: #111827; text-transform: uppercase; letter-spacing: 0.6px; }
		th:first-child { padding-left: 24px; }
		tbody tr { border-bottom: 1px solid #e9ecef; transition: background-color 0.2s; }
		tbody tr:hover { background-color: #f8f9fa; }
		tbody tr:last-child { border-bottom: none; }
		td { padding: 16px; vertical-align: middle; }
		td:first-child { padding-left: 24px; font-weight: 600; color: #111827; }
		.metric-cell { line-height: 1.6; }
		.actual-value { font-size: 18px; font-weight: 700; color: #111827; display: block; margin-bottom: 4px; }
		.plan-value { font-size: 11px; color: #6c757d; display: block; margin-bottom: 4px; }
		.variance { font-size: 12px; font-weight: 600; display: block; }
		.variance.positive { color: #00C853; }
		.variance.negative { color: #FF5252; }
		.variance.neutral { color: #9E9E9E; }

		/* ROAS cells — 0.6 saturation */
		.roas-cell { background-color: rgba(0, 0, 0, 0.03); font-weight: 700; text-align: center; }
		.roas-cell.green { background-color: rgba(16, 185, 129, 0.6); color: #064E3B; }
		.roas-cell.amber { background-color: rgba(245, 158, 11, 0.6); color: #7A2E0E; }
		.roas-cell.red { background-color: rgba(239, 68, 68, 0.6); color: #7F1D1D; }
		.roas-cell .actual-value, .roas-cell .plan-value, .roas-cell .variance { color: inherit; }

		.total-row { background: #f8f9fa; font-weight: 700; border-top: 2px solid #dee2e6; }
		.total-row td { padding: 18px 16px; }

		@media (max-width: 1024px) { .kpi-grid { grid-template-columns: repeat(2, 1fr); } }
		@media (max-width: 640px) {
			body { padding: 10px; }
			th, td { padding: 10px 8px; font-size: 12px; }
			.actual-value { font-size: 16px; }
			.kpi-grid { grid-template-columns: 1fr; }
			.filters-grid { grid-template-columns: 1fr; }
		}
	</style>
</head>
<body>
	<div class="dashboard-container">
		<!-- Filters Section -->
		<div class="filters-section">
			<div class="filters-grid">
				<div class="filter-group">
					<label class="filter-label">Duration Type</label>
					<select id="durationType">
						<option value="month">Monthly</option>
						<option value="quarter">Quarterly</option>
						<option value="year">Yearly</option>
						<option value="all">All Time</option>
					</select>
				</div>
				<div class="filter-group" id="monthFilter">
					<label class="filter-label">Month & Year</label>
					<select id="monthYear"><option value="">All Months</option></select>
				</div>
				<div class="filter-group" id="quarterFilter" style="display:none;">
					<label class="filter-label">Quarter</label>
					<select id="quarter">
						<option value="">All Quarters</option>
						<option value="Q1">Q1 (Jan-Mar)</option>
						<option value="Q2">Q2 (Apr-Jun)</option>
						<option value="Q3">Q3 (Jul-Sep)</option>
						<option value="Q4">Q4 (Oct-Dec)</option>
					</select>
				</div>
				<div class="filter-group" id="yearFilter" style="display:none;">
					<label class="filter-label">Year</label>
					<select id="year"><option value="">All Years</option></select>
				</div>
				<div class="filter-group">
					<label class="filter-label">Cluster</label>
					<select id="cluster"><option value="">All Clusters</option></select>
				</div>
				<div class="filter-group">
					<button class="apply-button" onclick="applyFilters()">Apply Filters</button>
				</div>
			</div>
		</div>

		<!-- KPI Cards (2 rows × 4 columns: Leads/Admissions, Spend/Revenue, CPL/Conversion, ROAS/P&L) -->
		<div class="kpi-grid">
			<div class="kpi-card" id="kpi-leads"></div>
			<div class="kpi-card" id="kpi-spend"></div>
			<div class="kpi-card" id="kpi-cpl"></div>
			<div class="kpi-card" id="kpi-roas"></div>

			<div class="kpi-card" id="kpi-admissions"></div>
			<div class="kpi-card" id="kpi-revenue"></div>
			<div class="kpi-card" id="kpi-conversion"></div>
			<div class="kpi-card" id="kpi-pl"></div>
		</div>

		<!-- Info Banner -->
		<div class="info-banner" id="infoBanner" style="display:none;">Loading data from Google Sheets...</div>
		<div id="errorMessage" class="error" style="display:none;"></div>

		<!-- Table Section -->
		<div class="table-container" id="tableContainer">
			<div class="loading">Loading data...</div>
		</div>
	</div>

	<script>
		const USE_SAMPLE_DATA = false;
		const USE_API = false;
		const API_KEY = 'YOUR_API_KEY_HERE';
		const SHEET_ID = 'YOUR_SHEET_ID';
		const SHEET_NAME = 'Sheet1';
		const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTEVY1wjKKOySULMlKauINBg0w6EFeqptOkg0JTEotpZljSFI-XSLiVyDqBrV1p70DKS9_PJ5y39kjq/pub?output=csv';

		let allData = [];
		let filteredData = [];

		document.getElementById('durationType').addEventListener('change', function() {
			const type = this.value;
			document.getElementById('monthFilter').style.display = type === 'month' ? 'block' : 'none';
			document.getElementById('quarterFilter').style.display = type === 'quarter' ? 'block' : 'none';
			document.getElementById('yearFilter').style.display = (type === 'quarter' || type === 'year') ? 'block' : 'none';
		});

		const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

		function parseMonthYear(monthYearStr) {
			const months = { Jan:0, Feb:1, Mar:2, Apr:3, May:4, Jun:5, Jul:6, Aug:7, Sep:8, Oct:9, Nov:10, Dec:11,
				January:0, February:1, March:2, April:3, May2:4, June:5, July:6, August:7, September:8, October:9, November:10, December:11 };
			const parts = (monthYearStr || '').trim().split(' ');
			if (parts.length >= 2) {
				const month = parts[0];
				const year = parseInt(parts[1]);
				return { month, year, monthIndex: months[month] ?? 0 };
			}
			return { month: '', year: 0, monthIndex: 0 };
		}
		function getQuarter(monthIndex) { if (monthIndex<=2) return 'Q1'; if (monthIndex<=5) return 'Q2'; if (monthIndex<=8) return 'Q3'; return 'Q4'; }

		function parseCSV(text) {
			const lines = text.split('\n').filter(l => l.trim() !== '');
			return lines.map(row => {
				const cols = []; let current = ''; let inQuotes = false;
				for (let i = 0; i < row.length; i++) {
					const c = row[i];
					if (c === '"') { if (inQuotes && row[i+1] === '"') { current += '"'; i++; } else inQuotes = !inQuotes; }
					else if (c === ',' && !inQuotes) { cols.push(current.trim()); current = ''; }
					else { current += c; }
				}
				cols.push(current.trim());
				return cols;
			});
		}
		function normalizeKey(s) { return (s || '').replace(/\s+/g,'_').replace(/[()]/g,'').replace(/&/g,'and').replace(/%/g,'pct').replace(/\./g,'').trim(); }
		function parseNumber(str) { if (str==null || str==='') return 0; const n=parseFloat(String(str).replace(/[₹$,]/g,'')); return isNaN(n)?0:n; }
		function parsePercentage(str) { if (str==null || str==='') return 0; const n=parseFloat(String(str).replace(/%/g,'')); return isNaN(n)?0:n; }
		function buildHeaderIndex(headers) { const idx={}; headers.forEach((h,i)=>idx[normalizeKey(h)]=i); return idx; }
		function getIndex(headerIdx, candidates) { for (const c of candidates) { const k=normalizeKey(c); if (headerIdx[k]!=null) return headerIdx[k]; } return -1; }

		async function fetchSheetData() {
			const infoBanner = document.getElementById('infoBanner');
			const errorMessage = document.getElementById('errorMessage');
			infoBanner.style.display = 'block';
			infoBanner.textContent = 'Loading data from Google Sheets...';
			errorMessage.style.display = 'none';

			try {
				let csvText;
				if (USE_SAMPLE_DATA) {
					const SAMPLE = [
						['University','Cluster','Month_Year','Actual_Leads','Revised_Leads','Actual_Admissions','Revised_Admissions','Actual_Revenue','Revised_Revenue','Actual_PL','Revised_PL','Actual_Spend','Revised_Spend','Actual_CPL','Revised_CPL','Actual_CPA','Revised_CPA','Actual_ROAS','Revised_ROAS','Actual_Conversion_Rate','Revised_Conversion_Rate'],
						['AMET','Cluster A','Apr 2024',1850,1700,295,272,885000,816000,266000,245000,245000,255000,132,150,831,938,3.6,3.2,15.9,16.0],
						['AMET','Cluster A','May 2024',920,850,147,136,588000,544000,176000,163000,142000,145000,154,171,966,1066,4.1,3.8,16.0,16.0],
						['University B','Cluster B','Apr 2024',890,800,142,128,355000,320000,107000,96000,118000,120000,133,150,831,938,3.0,2.7,16.0,16.0],
					];
					csvText = SAMPLE.map(r => r.join(',')).join('\n');
					infoBanner.textContent = 'Using sample data (configure Google Sheets connection)';
				} else if (USE_API) {
					const apiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;
					const response = await fetch(apiUrl);
					const data = await response.json();
					if (!data.values) throw new Error('No data returned from API');
					csvText = data.values.map(row => row.join(',')).join('\n');
				} else {
					const response = await fetch(SHEET_URL);
					csvText = await response.text();
				}

				const rows = parseCSV(csvText);
				if (rows.length === 0) throw new Error('Empty sheet');

				const headers = rows[0];
				const headerIdx = buildHeaderIndex(headers);

				const idxUniversity = getIndex(headerIdx, ['University']);
				const idxCluster = getIndex(headerIdx, ['Cluster']);
				const idxMonthYear = getIndex(headerIdx, ['Month_Year','Month Year','MonthYear']);

				function idxPair(base) {
					return {
						a: getIndex(headerIdx, [`Actual_${base}`, `Actual ${base}`, `Actual${base}`]),
						r: getIndex(headerIdx, [`Revised_${base}`, `Revised ${base}`, `Plan_${base}`, `Planned_${base}`, `Revised${base}`, `Plan ${base}`]),
					};
				}
				const leadsIdx = idxPair('Leads');
				const admissionsIdx = idxPair('Admissions');
				const spendIdx = idxPair('Spend');
				const revenueIdx = idxPair('Revenue');
				const cplIdx = idxPair('CPL'); // ignored, derived later
				const convIdx = idxPair('Conversion_Rate');
				const plIdx = idxPair('PL');
				const roasIdx = idxPair('ROAS'); // ignored, derived later

				allData = rows.slice(1).filter(r => r[idxUniversity] && String(r[idxUniversity]).trim() !== '').map(r => {
					const monthYearRaw = idxMonthYear !== -1 ? r[idxMonthYear] : '';
					const monthYearInfo = parseMonthYear(monthYearRaw);
					const read = (pair, which, parser = parseNumber) => (pair[which] === -1 ? 0 : parser(r[pair[which]]));
					const pairVals = (pair, parser = parseNumber) => ({ actual: read(pair,'a',parser), plan: read(pair,'r',parser) });
					return {
						university: idxUniversity !== -1 ? r[idxUniversity] : '',
						cluster: idxCluster !== -1 ? r[idxCluster] : '',
						monthYear: monthYearRaw,
						month: monthYearInfo.month,
						year: monthYearInfo.year,
						monthIndex: monthYearInfo.monthIndex,
						leads: pairVals(leadsIdx),
						admissions: pairVals(admissionsIdx),
						spend: pairVals(spendIdx),
						revenue: pairVals(revenueIdx),
						cplFromSheet: pairVals(cplIdx),
						roasFromSheet: pairVals(roasIdx),
						convRate: pairVals(convIdx, parsePercentage),
						pl: pairVals(plIdx)
					};
				});

				populateFilters();
				infoBanner.style.display = 'none';
				applyFilters();
			} catch (e) {
				console.error(e);
				const errorMessage = document.getElementById('errorMessage');
				errorMessage.textContent = `Error loading data: ${e.message}. Please ensure the sheet is published and headers match Actual_*, Revised_* names.`;
				errorMessage.style.display = 'block';
				document.getElementById('infoBanner').style.display = 'none';
				document.getElementById('tableContainer').innerHTML = '<div class="loading">Failed to load data</div>';
			}
		}

		function clearSelect(selectEl, allLabel) {
			while (selectEl.firstChild) selectEl.removeChild(selectEl.firstChild);
			const opt = document.createElement('option');
			opt.value = '';
			opt.textContent = allLabel;
			selectEl.appendChild(opt);
		}

		function populateFilters() {
			// Month-Year options (robust build)
			const monthYearSelect = document.getElementById('monthYear');
			clearSelect(monthYearSelect, 'All Months');

			// Prefer existing monthYear string; if missing, synthesize from monthIndex + year
			const monthYearSet = new Set();
			allData.forEach(row => {
				let label = (row.monthYear || '').trim();
				if (!label && row.year > 0) {
					const mi = Number(row.monthIndex);
					if (!Number.isNaN(mi) && mi >= 0 && mi <= 11) {
						label = `${monthNames[mi]} ${row.year}`;
					}
				}
				if (label) monthYearSet.add(label);
			});

			const monthYearList = Array.from(monthYearSet);
			// Sort by year then month if parsable; else alpha
			monthYearList.sort((a, b) => {
				const [am, ay] = a.split(' ');
				const [bm, by] = b.split(' ');
				const ai = monthNames.indexOf(am);
				const bi = monthNames.indexOf(bm);
				const ayNum = parseInt(ay) || 0;
				const byNum = parseInt(by) || 0;
				if (ayNum !== byNum) return ayNum - byNum;
				return ai - bi;
			});
			monthYearList.forEach(label => {
				const option = document.createElement('option');
				option.value = label;
				option.textContent = label;
				monthYearSelect.appendChild(option);
			});

			// Years
			const yearSelect = document.getElementById('year');
			clearSelect(yearSelect, 'All Years');
			const years = [...new Set(allData.map(r => r.year).filter(y => y && y > 0))].sort((a,b) => b - a);
			years.forEach(y => {
				const option = document.createElement('option');
				option.value = y;
				option.textContent = y;
				yearSelect.appendChild(option);
			});

			// Clusters
			const clusterSelect = document.getElementById('cluster');
			clearSelect(clusterSelect, 'All Clusters');
			const clusters = [...new Set(allData.map(r => r.cluster).filter(Boolean))].sort();
			clusters.forEach(c => {
				const option = document.createElement('option');
				option.value = c;
				option.textContent = c;
				clusterSelect.appendChild(option);
			});
		}

		function applyFilters() {
			const durationType = document.getElementById('durationType').value;
			const selectedMonthYear = document.getElementById('monthYear').value;
			const selectedQuarter = document.getElementById('quarter').value;
			const selectedYear = document.getElementById('year').value;
			const selectedCluster = document.getElementById('cluster').value;

			let filtered = allData.filter(row => {
				if (selectedCluster && row.cluster !== selectedCluster) return false;
				if (durationType === 'month' && selectedMonthYear && row.monthYear !== selectedMonthYear) return false;
				if (durationType === 'quarter') {
					if (selectedYear && row.year != selectedYear) return false;
					if (selectedQuarter && getQuarter(row.monthIndex) !== selectedQuarter) return false;
				}
				if (durationType === 'year' && selectedYear && row.year != selectedYear) return false;
				return true;
			});

			// Aggregate by university with SUMS; derive CPL and ROAS from sums
			const aggregated = {};
			filtered.forEach(row => {
				const k = row.university;
				if (!aggregated[k]) {
					aggregated[k] = {
						university: row.university,
						leads: { actual: 0, plan: 0 },
						admissions: { actual: 0, plan: 0 },
						spend: { actual: 0, plan: 0 },
						revenue: { actual: 0, plan: 0 },
						pl: { actual: 0, plan: 0 },
						convRate: { actual: 0, plan: 0 },
						count: 0,
						cpl: { actual: 0, plan: 0 },
						roas: { actual: 0, plan: 0 }
					};
				}
				const a = aggregated[k];
				a.leads.actual += row.leads.actual; a.leads.plan += row.leads.plan;
				a.admissions.actual += row.admissions.actual; a.admissions.plan += row.admissions.plan;
				a.spend.actual += row.spend.actual; a.spend.plan += row.spend.plan;
				a.revenue.actual += row.revenue.actual; a.revenue.plan += row.revenue.plan;
				a.pl.actual += row.pl.actual; a.pl.plan += row.pl.plan;
				a.convRate.actual += row.convRate.actual; a.convRate.plan += row.convRate.plan;
				a.count++;
			});

			Object.values(aggregated).forEach(r => {
				r.cpl.actual = (r.leads.actual > 0) ? (r.spend.actual / r.leads.actual) : 0;
				r.cpl.plan = (r.leads.plan > 0) ? (r.spend.plan / r.leads.plan) : 0;
				r.roas.actual = (r.spend.actual > 0) ? (r.revenue.actual / r.spend.actual) : 0;
				r.roas.plan = (r.spend.plan > 0) ? (r.revenue.plan / r.spend.plan) : 0;
				if (r.count > 0) { r.convRate.actual /= r.count; r.convRate.plan /= r.count; }
			});

			filteredData = Object.values(aggregated);
			renderKPIs(filteredData);
			renderTable();
		}

		function calculateVariance(actual, plan) { if (plan === 0) return 0; return ((actual - plan) / plan) * 100; }
		function formatNumber(num) { return Math.round(num).toLocaleString('en-IN'); }
		function formatCurrency(num) { const n=Math.round(num); return n>=100000 ? `₹${(n/1000).toFixed(0)}k` : `₹${n.toLocaleString('en-IN')}`; }
		function formatPercentage(num) { return `${num.toFixed(1)}%`; }
		function formatVariance(variance) {
			const r = Math.round(variance * 10) / 10;
			if (variance > 0) return `<span class="variance positive">↗ +${r}%</span>`;
			if (variance < 0) return `<span class="variance negative">↘ ${r}%</span>`;
			return `<span class="variance neutral">↔ 0%</span>`;
		}
		function createMetricCell(actual, plan, format = 'number') {
			const variance = calculateVariance(actual, plan);
			const fmt = (v) => format === 'currency' ? formatCurrency(v) :
				format === 'percentage' ? formatPercentage(v) :
				format === 'decimal' ? v.toFixed(1) : formatNumber(v);
			return `
				<div class="metric-cell">
					<span class="actual-value">${fmt(actual)}</span>
					<span class="plan-value">Plan: ${fmt(plan)}</span>
					${formatVariance(variance)}
				</div>
			`;
		}
		function getROASClass(actual, revised) {
			if (revised === 0) return '';
			if (actual >= revised) return 'green';
			const drop = (revised - actual) / revised;
			if (drop <= 0.2) return 'amber';
			return 'red';
		}

		function kpiCardHTML(title, actual, plan, type) {
			const fmt = (v) => type === 'currency' ? formatCurrency(v) :
				type === 'percentage' ? formatPercentage(v) :
				type === 'decimal' ? v.toFixed(1) : formatNumber(v);
			const pct = plan === 0 ? 0 : Math.max(0, (actual / plan) * 100);
			const pctCapped = Math.min(pct, 150);
			const good = actual >= plan;
			const fillClass = good ? 'fill-green' : 'fill-red';
			const textClass = good ? 'kpi-green' : 'kpi-red';
			return `
				<div class="kpi-title">${title}</div>
				<div class="kpi-actual">${fmt(actual)}</div>
				<div class="kpi-revised">Plan: ${fmt(plan)}</div>
				<div class="bullet-track"><div class="bullet-fill ${fillClass}" style="width:${pctCapped}%"></div></div>
				<div class="kpi-percent ${textClass}">${(Math.round(pct * 10) / 10).toFixed(1)}%</div>
			`;
		}

		function renderKPIs(rows) {
			// Totals across universities for the selected duration
			const totals = {
				leads: { actual: 0, plan: 0 },
				admissions: { actual: 0, plan: 0 },
				spend: { actual: 0, plan: 0 },
				revenue: { actual: 0, plan: 0 },
				pl: { actual: 0, plan: 0 },
				convRateSum: { actual: 0, plan: 0 },
				count: rows.length
			};
			rows.forEach(r => {
				totals.leads.actual += r.leads.actual; totals.leads.plan += r.leads.plan;
				totals.admissions.actual += r.admissions.actual; totals.admissions.plan += r.admissions.plan;
				totals.spend.actual += r.spend.actual; totals.spend.plan += r.spend.plan;
				totals.revenue.actual += r.revenue.actual; totals.revenue.plan += r.revenue.plan;
				totals.pl.actual += r.pl.actual; totals.pl.plan += r.pl.plan;
				totals.convRateSum.actual += r.convRate.actual; totals.convRateSum.plan += r.convRate.plan;
			});
			// Derived CPL and ROAS from sums
			const derivedCPL = {
				actual: (totals.leads.actual > 0) ? totals.spend.actual / totals.leads.actual : 0,
				plan: (totals.leads.plan > 0) ? totals.spend.plan / totals.leads.plan : 0
			};
			const derivedROAS = {
				actual: (totals.spend.actual > 0) ? totals.revenue.actual / totals.spend.actual : 0,
				plan: (totals.spend.plan > 0) ? totals.revenue.plan / totals.spend.plan : 0
			};
			const avgConv = {
				actual: (totals.count > 0) ? (totals.convRateSum.actual / totals.count) : 0,
				plan: (totals.count > 0) ? (totals.convRateSum.plan / totals.count) : 0
			};

			document.getElementById('kpi-leads').innerHTML = kpiCardHTML('Leads', totals.leads.actual, totals.leads.plan, 'number');
			document.getElementById('kpi-admissions').innerHTML = kpiCardHTML('Admissions', totals.admissions.actual, totals.admissions.plan, 'number');
			document.getElementById('kpi-spend').innerHTML = kpiCardHTML('Spend', totals.spend.actual, totals.spend.plan, 'currency');
			document.getElementById('kpi-revenue').innerHTML = kpiCardHTML('Revenue', totals.revenue.actual, totals.revenue.plan, 'currency');
			document.getElementById('kpi-cpl').innerHTML = kpiCardHTML('CPL', derivedCPL.actual, derivedCPL.plan, 'currency');
			document.getElementById('kpi-conversion').innerHTML = kpiCardHTML('Conversion Rate', avgConv.actual, avgConv.plan, 'percentage');
			document.getElementById('kpi-pl').innerHTML = kpiCardHTML('P&L', totals.pl.actual, totals.pl.plan, 'currency');
			document.getElementById('kpi-roas').innerHTML = kpiCardHTML('ROAS', derivedROAS.actual, derivedROAS.plan, 'decimal');
		}

		function renderTable() {
			const container = document.getElementById('tableContainer');
			if (filteredData.length === 0) {
				container.innerHTML = '<div class="loading">No data available for selected filters</div>';
				return;
			}

			let html = `
				<table>
					<thead>
						<tr>
							<th>University</th>
							<th>Leads</th>
							<th>Admissions</th>
							<th>Spend</th>
							<th>Revenue</th>
							<th>CPL</th>
							<th>P&L</th>
							<th>ROAS ⭐</th>
						</tr>
					</thead>
					<tbody>
			`;

			// Totals for derived CPL/ROAS
			const totals = {
				leads: { actual: 0, plan: 0 },
				admissions: { actual: 0, plan: 0 },
				spend: { actual: 0, plan: 0 },
				revenue: { actual: 0, plan: 0 },
				pl: { actual: 0, plan: 0 }
			};

			filteredData.forEach(row => {
				const roasClass = getROASClass(row.roas.actual, row.roas.plan);
				html += `
					<tr>
						<td>${row.university}</td>
						<td>${createMetricCell(row.leads.actual, row.leads.plan)}</td>
						<td>${createMetricCell(row.admissions.actual, row.admissions.plan)}</td>
						<td>${createMetricCell(row.spend.actual, row.spend.plan, 'currency')}</td>
						<td>${createMetricCell(row.revenue.actual, row.revenue.plan, 'currency')}</td>
						<td>${createMetricCell(row.cpl.actual, row.cpl.plan, 'currency')}</td>
						<td>${createMetricCell(row.pl.actual, row.pl.plan, 'currency')}</td>
						<td class="roas-cell ${roasClass}">
							${createMetricCell(row.roas.actual, row.roas.plan, 'decimal')}
						</td>
					</tr>
				`;
				totals.leads.actual += row.leads.actual; totals.leads.plan += row.leads.plan;
				totals.admissions.actual += row.admissions.actual; totals.admissions.plan += row.admissions.plan;
				totals.spend.actual += row.spend.actual; totals.spend.plan += row.spend.plan;
				totals.revenue.actual += row.revenue.actual; totals.revenue.plan += row.revenue.plan;
				totals.pl.actual += row.pl.actual; totals.pl.plan += row.pl.plan;
			});

			const totalsCPL = {
				actual: (totals.leads.actual > 0) ? totals.spend.actual / totals.leads.actual : 0,
				plan: (totals.leads.plan > 0) ? totals.spend.plan / totals.leads.plan : 0
			};
			const totalsROAS = {
				actual: (totals.spend.actual > 0) ? totals.revenue.actual / totals.spend.actual : 0,
				plan: (totals.spend.plan > 0) ? totals.revenue.plan / totals.spend.plan : 0
			};
			const totalRoasClass = getROASClass(totalsROAS.actual, totalsROAS.plan);

			html += `
				<tr class="total-row">
					<td>Total</td>
					<td>${createMetricCell(totals.leads.actual, totals.leads.plan)}</td>
					<td>${createMetricCell(totals.admissions.actual, totals.admissions.plan)}</td>
					<td>${createMetricCell(totals.spend.actual, totals.spend.plan, 'currency')}</td>
					<td>${createMetricCell(totals.revenue.actual, totals.revenue.plan, 'currency')}</td>
					<td>${createMetricCell(totalsCPL.actual, totalsCPL.plan, 'currency')}</td>
					<td>${createMetricCell(totals.pl.actual, totals.pl.plan, 'currency')}</td>
					<td class="roas-cell ${totalRoasClass}">
						${createMetricCell(totalsROAS.actual, totalsROAS.plan, 'decimal')}
					</td>
				</tr>
			`;

			html += '</tbody></table>';
			container.innerHTML = html;
		}

		window.addEventListener('DOMContentLoaded', () => { fetchSheetData(); });
	</script>
</body>
</html>
