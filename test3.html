<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	<title>University Performance Dashboard</title>
	<style>


			/* ===== TABLE WRAPPER ===== */
			#tableWrapper {
			  position: relative;
			  overflow-y: auto;
			  border: 1px solid #ddd;
			  margin-bottom: 40px;
			  max-height: 650px; /* Adjusted height for 7 total visible rows (2 frozen + 5 scrollable) */
			  border-radius: 8px;
			}
			
			/* ===== HEADER (Frozen) ===== */
			#mainTable thead th {
			  position: sticky;
			  top: 0;
			  background: #f3f4f6; /* soft grey header background */
			  color: #111827;
			  z-index: 3;
			  font-weight: 600;
			  border-bottom: 2px solid #ccc;
			}
			
			/* ===== TOTAL ROW (Frozen) ===== */
			#mainTable .total-row {
			  position: sticky;
			  bottom: 0;
			  background: #f3f4f6; /* same color as header */
			  color: #111827;
			  font-weight: 600;
			  z-index: 3;
			  border-top: 2px solid #ccc;
			}
			
			/* Allow ROAS highlight to override total-row background */
			#mainTable .total-row .roas-cell.green { background: #d1fae5 !important; color: #065f46; font-weight: bold; }
			#mainTable .total-row .roas-cell.red { background: #fee2e2 !important; color: #991b1b; font-weight: bold; }
			#mainTable .total-row .roas-cell.amber { background: #fef9c3 !important; color: #92400e; font-weight: bold; }
			
			/* ===== TABLE BASE ===== */
			#mainTable {
			  width: 100%;
			  border-collapse: collapse;
			  font-family: 'Inter', sans-serif;
			  font-size: 14px;
			  line-height: 1.5;
			}
			
			/* ===== CELLS ===== */
			#mainTable th,
			#mainTable td {
			  padding: 10px 8px;
			  text-align: center;
			  border-bottom: 1px solid #eee;
			  border-left: none;
			  border-right: none;
			}
			
			/* ===== REMOVE vertical lines ===== */
			#mainTable th,
			#mainTable td {
			  border-left: none;
			  border-right: none;
			}
			
			/* ===== SCROLLBAR (Optional) ===== */
			#tableWrapper::-webkit-scrollbar {
			  width: 8px;
			}
			#tableWrapper::-webkit-scrollbar-thumb {
			  background: #ccc;
			  border-radius: 4px;
			}



		
			.sort-btn {
			  background: none;
			  border: none;
			  color: #6b7280;
			  font-size: 10px;
			  cursor: pointer;
			  padding: 0 2px;
			  transition: color 0.2s ease;
			}
			
			.sort-btn:hover {
			  color: #111827;
			}
			
			th {
			  text-align: left;
			  font-weight: 600;
			  color: #111827;
			  padding: 8px 10px;
			  white-space: nowrap;
			}

		
				.sort-btn {
			background: none;
			border: none;
			font-weight: 600;
			cursor: pointer;
			color: #333;
			font-size: 14px;
		}
		.sort-btn:hover {
			color: #2563eb;
			text-decoration: underline;
		}

		/* (your original CSS kept intact) */
		* { margin: 0; padding: 0; box-sizing: border-box; }
		body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; background: #f5f5f5; padding: 20px; }
		.dashboard-container { max-width: 1600px; margin: 0 auto; }
		.filters-section { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
		.filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end; }
		.filter-group { display: flex; flex-direction: column; }
		.filter-label { font-size: 12px; font-weight: 600; color: #495057; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
		select { padding: 10px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px; color: #495057; background-color: white; cursor: pointer; transition: border-color 0.2s; }
		select:hover { border-color: #80bdff; }
		select:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
		.apply-button { padding: 10px 24px; background: #007bff; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
		.apply-button:hover { background: #0056b3; }
		.apply-button:active { transform: scale(0.98); }
		.kpi-section { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
		.kpi-card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s; }
		.kpi-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
		.kpi-card.highlight { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
		.kpi-card.highlight .kpi-label, .kpi-card.highlight .kpi-plan { color: rgba(255, 255, 255, 0.9); }
		.kpi-label { font-size: 12px; font-weight: 600; color: #6c757d; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
		.kpi-value { font-size: 32px; font-weight: 700; color: #212529; margin-bottom: 5px; }
		.kpi-card.highlight .kpi-value { color: white; }
		.kpi-plan { font-size: 14px; color: #6c757d; margin-bottom: 10px; }
		.bullet-chart { height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden; margin-bottom: 5px; }
		.bullet-fill { height: 100%; transition: width 0.5s ease; border-radius: 4px; }
		.bullet-fill.green { background: #00C853; }
		.bullet-fill.red { background: #FF5252; }
		.bullet-fill.grey { background: #9E9E9E; }
		.kpi-percentage { font-size: 12px; font-weight: 600; }
		.kpi-percentage.green { color: #00C853; }
		.kpi-percentage.red { color: #FF5252; }
		.kpi-percentage.grey { color: #9E9E9E; }
		.loading { text-align: center; padding: 40px; color: #6c757d; }
		.error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 6px; margin-bottom: 20px; display:none; }
		.table-container { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow-x: auto; }
		table { width: 100%; border-collapse: collapse; min-width: 1100px; }
		thead { background: #f8f9fa; border-bottom: 2px solid #dee2e6; position: sticky; top: 0; z-index: 10; }
		th { padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: #495057; text-transform: uppercase; letter-spacing: 0.5px; }
		th:first-child { padding-left: 24px; }
		tbody tr { border-bottom: 1px solid #e9ecef; transition: background-color 0.2s; }
		tbody tr:hover { background-color: #f8f9fa; }
		tbody tr:last-child { border-bottom: none; }
		td { padding: 16px; vertical-align: middle; }
		td:first-child { padding-left: 24px; font-weight: 500; color: #212529; }
		.metric-cell { line-height: 1.6; }
		.actual-value { font-size: 18px; font-weight: 600; color: #212529; display: block; margin-bottom: 4px; }
		.plan-value { font-size: 11px; color: #6c757d; display: block; margin-bottom: 4px; }
		.variance { font-size: 12px; font-weight: 500; display: block; }
		.variance.positive { color: #00C853; }
		.variance.negative { color: #FF5252; }
		.variance.neutral { color: #9E9E9E; }
		.roas-cell { background-color: rgba(0, 0, 0, 0.03); font-weight: 700; text-align: center; }
		.roas-cell.green { background-color: rgba(16, 185, 129, 0.60); color: #064E3B; }
		.roas-cell.amber { background-color: rgba(245, 158, 11, 0.60); color: #7A2E0E; }
		.roas-cell.red   { background-color: rgba(239, 68, 68, 0.60);  color: #7F1D1D; }
		.roas-cell .actual-value, .roas-cell .plan-value, .roas-cell .variance { color: inherit; }
		.total-row { background: #f8f9fa; font-weight: 600; border-top: 2px solid #dee2e6; }
		.total-row td { padding: 18px 16px; }
		.info-banner { background: #d1ecf1; color: #0c5460; padding: 12px 20px; border-radius: 6px; margin-bottom: 20px; font-size: 14px; display:none;}
		@media (max-width: 768px) { body { padding: 10px; } .kpi-section { grid-template-columns: repeat(2, 1fr); } th, td { padding: 10px 8px; font-size: 12px; } .actual-value { font-size: 16px; } .filters-grid { grid-template-columns: 1fr; } }
	</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>
	<div class="dashboard-container">
		<div class="filters-section">
			<div class="filters-grid">
				<div class="filter-group">
					<label class="filter-label">Duration Type</label>
					<select id="durationType">
						<option value="month">Monthly</option>
						<option value="quarter">Quarterly</option>
						<option value="year">Yearly</option>
						<option value="all">All Time</option>
					</select>
				</div>
				
				<div class="filter-group" id="monthFilter">
					<label class="filter-label">Month & Year</label>
					<select id="monthYear">
						<option value="">All Months</option>
					</select>
				</div>

				<div class="filter-group" id="quarterFilter" style="display:none;">
					<label class="filter-label">Quarter</label>
					<select id="quarter">
						<option value="">All Quarters</option>
						<option value="Q1">Q1 (Jan-Mar)</option>
						<option value="Q2">Q2 (Apr-Jun)</option>
						<option value="Q3">Q3 (Jul-Sep)</option>
						<option value="Q4">Q4 (Oct-Dec)</option>
					</select>
				</div>
				
				<div class="filter-group" id="yearFilter" style="display:none;">
					<label class="filter-label">Year</label>
					<select id="year">
						<option value="">All Years</option>
					</select>
				</div>

				<div class="filter-group">
					<label class="filter-label">Cluster</label>
					<select id="cluster">
						<option value="">All Clusters</option>
					</select>
				</div>

				<div class="filter-group">
					<button class="apply-button" onclick="applyFilters()">Apply Filters</button>
				</div>
			</div>
		</div>

		<div class="kpi-section" id="kpiSection"></div>
		<div class="info-banner" id="infoBanner"></div>
		<div id="errorMessage" class="error"></div>
		<div id="tableWrapper">
		  <div id="tableContainer"></div>
		</div>


				<!-- ===== PERFORMANCE TREND CHART SECTION ===== -->
		<div style="margin-top: 50px; padding: 20px; border-radius: 12px; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
		  <h3 style="font-size: 18px; font-weight: 600; color: #111827; margin-bottom: 16px;">Performance Trend</h3>
		  
		  <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
		    <div>
		      <label for="metricSelect" style="font-weight: 500; color: #374151;">Metric:</label>
		      <select id="metricSelect" style="margin-left: 8px; padding: 5px 10px; border-radius: 6px; border: 1px solid #d1d5db;">
		        <option>Revenue</option>
		        <option>Leads</option>
		        <option>Admissions</option>
		        <option>Spend</option>
		        <option>CPL</option>
		        <option>Conversion Rate</option>
		        <option>P&L</option>
		        <option>ROAS</option>
		      </select>
		    </div>
		
		    <div>
		      <label for="durationSelect" style="font-weight: 500; color: #374151;">Duration:</label>
		      <select id="durationSelect" style="margin-left: 8px; padding: 5px 10px; border-radius: 6px; border: 1px solid #d1d5db;">
		        <option value="3">3 Months</option>
		        <option value="6">6 Months</option>
		        <option value="7" selected>7 Months</option>
		        <option value="12">1 Year</option>
		      </select>
		    </div>
		  </div>
		
		  <div style="height: 400px;">
		    <canvas id="performanceChart"></canvas>
		  </div>
		</div>

				<!-- ===== YEAR-TO-DATE PERFORMANCE CHART ===== -->
		<div style="margin-top: 50px; padding: 20px; border-radius: 12px; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
		  <h3 style="font-size: 18px; font-weight: 600; color: #111827; margin-bottom: 16px;">Year-to-Date Performance</h3>
		
		  <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap; margin-bottom: 15px;">
		    <!-- KPI Dropdown -->
		    <div>
		      <label for="ytdMetricSelect" style="font-weight: 500; color: #374151;">Select KPI:</label>
		      <select id="ytdMetricSelect" style="margin-left: 8px; padding: 5px 10px; border-radius: 6px; border: 1px solid #d1d5db;">
		        <option>Revenue</option>
		        <option>Leads</option>
		        <option>Admissions</option>
		        <option>Spend</option>
		        <option>P&L</option>
		        <option>CPL</option>
		        <option>Conversion Rate</option>
		        <option>ROAS</option>
		      </select>
		    </div>
		
		    <!-- Year Dropdown (NEWLY ADDED) -->
		    <div>
		      <label for="yearSelect" style="font-weight: 500; color: #374151;">Select Year:</label>
		      <select id="yearSelect" style="margin-left: 8px; padding: 5px 10px; border-radius: 6px; border: 1px solid #d1d5db;"></select>
		    </div>
		  </div>
		
		  <div style="height: 400px;">
		    <canvas id="ytdPerformanceChart"></canvas>
		  </div>
		</div>

	</div>

	<script>
		// ============================================
		// CONFIGURATION - SET YOUR GOOGLE SHEET HERE
		// ============================================
		const USE_SAMPLE_DATA = false; // Set to FALSE to use Google Sheet
		const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTEVY1wjKKOySULMlKauINBg0w6EFeqptOkg0JTEotpZljSFI-XSLiVyDqBrV1p70DKS9_PJ5y39kjq/pub?output=csv';
		// Alternative (not used here): USE_API = true, etc.

		// ============================================
		// SAMPLE DATA - retained for fallback / dev
		// ============================================
		const sampleData = [
			{ university: 'AMET', cluster: 'Cluster A', monthYear: 'Apr 2024', leads: {actual: 1850, plan: 1700}, admissions: {actual: 295, plan: 272}, revenue: {actual: 885000, plan: 816000}, pl: {actual: 266000, plan: 245000}, spend: {actual: 245000, plan: 255000} },
			{ university: 'AMET', cluster: 'Cluster A', monthYear: 'May 2024', leads: {actual: 920, plan: 850}, admissions: {actual: 147, plan: 136}, revenue: {actual: 588000, plan: 544000}, pl: {actual: 176000, plan: 163000}, spend: {actual: 142000, plan: 145000} },
			{ university: 'University B', cluster: 'Cluster B', monthYear: 'Apr 2024', leads: {actual: 890, plan: 800}, admissions: {actual: 142, plan: 128}, revenue: {actual: 355000, plan: 320000}, pl: {actual: 107000, plan: 96000}, spend: {actual: 118000, plan: 120000} },
			{ university: 'University C', cluster: 'Cluster C', monthYear: 'May 2024', leads: {actual: 680, plan: 650}, admissions: {actual: 110, plan: 105}, revenue: {actual: 360000, plan: 340000}, pl: {actual: 130000, plan: 125000}, spend: {actual: 120000, plan: 125000} },
		];

		let allData = [];
		let filteredData = [];
		let totals = {};

		// small CSV parser that handles quoted fields
		function parseCSV(text) {
			const rows = [];
			let cur = '';
			let row = [];
			let inQuotes = false;
			for (let i = 0; i < text.length; i++) {
				const ch = text[i];
				const nxt = text[i+1];
				if (ch === '"' ) {
					if (inQuotes && nxt === '"') { // escaped quote
						cur += '"'; i++; continue;
					}
					inQuotes = !inQuotes;
					continue;
				}
				if (!inQuotes && (ch === '\n' || ch === '\r')) {
					// handle CRLF
					if (ch === '\r' && nxt === '\n') { i++; }
					row.push(cur);
					rows.push(row);
					cur = '';
					row = [];
					continue;
				}
				if (!inQuotes && ch === ',') {
					row.push(cur);
					cur = '';
					continue;
				}
				cur += ch;
			}
			// push last
			if (cur !== '' || row.length > 0) {
				row.push(cur);
				rows.push(row);
			}
			// remove any empty trailing rows
			return rows.filter(r => !(r.length === 1 && r[0] === ''));
		}

		// Normalize header name to snake_case lower
		function normalizeHeader(h) {
			return h.trim().replace(/\s+/g, '_').replace(/[^\w_]/g,'').toLowerCase();
		}

		async function loadSheetData(csvUrl) {
			const res = await fetch(csvUrl);
			if (!res.ok) throw new Error('Failed to fetch sheet CSV (status ' + res.status + ')');
			const csvText = await res.text();
			const rows = parseCSV(csvText);
			if (!rows || rows.length < 1) throw new Error('CSV appears empty or malformed');

			const rawHeaders = rows[0].map(h => h.trim());
			const headers = rawHeaders.map(normalizeHeader);

			const dataRows = rows.slice(1);
			const nowYear = new Date().getFullYear();

			const monthMap = {'jan':0,'feb':1,'mar':2,'apr':3,'may':4,'jun':5,'jul':6,'aug':7,'sep':8,'oct':9,'nov':10,'dec':11};

			return dataRows.map(cols => {
				const obj = {};
				headers.forEach((h, i) => {
					obj[h] = (cols[i] !== undefined) ? cols[i].trim() : '';
				});

				// Month value may contain year (e.g., "Apr 2024") or just month ("Apr")
				let monthRaw = (obj['month'] || obj['monthyear'] || '').trim();
				let month = monthRaw;
				let year = null;

				// try to find a 4-digit year in the monthRaw
				const yearMatch = monthRaw.match(/(20\d{2}|19\d{2})/);
				if (yearMatch) {
					year = parseInt(yearMatch[0], 10);
					// remove year from month string
					month = monthRaw.replace(yearMatch[0], '').trim();
				}

				// if no year found, look for a separate year column
				if (!year && obj['year']) {
					const y = parseInt(obj['year']);
					if (!isNaN(y)) year = y;
				}

				if (!year) year = nowYear;

				// normalize month to three-letter capitalized (e.g., Apr)
				let monthShort = month;
				if (month) {
					const first = month.slice(0,3).toLowerCase();
					monthShort = first.charAt(0).toUpperCase() + first.slice(1);
				} else {
					// fallback: use month number if present
					monthShort = '';
				}

				const safeNum = v => {
					if (v === undefined || v === null || v === '') return 0;
					// remove commas, currency symbols
					const cleaned = String(v).replace(/[,₹\s]/g,'').replace(/--/g,'0');
					const n = parseFloat(cleaned);
					return isNaN(n) ? 0 : n;
				};

				// map expected numeric columns using normalized keys
				const row = {
					university: obj['university'] || obj['college'] || '',
					cluster: obj['cluster'] || '',
					monthYear: (monthShort ? monthShort + ' ' + year : String(year)),
					month: monthShort,
					year: year,
					monthIndex: monthMap[(monthShort||'').toLowerCase()] ?? 0,
					leads: { actual: safeNum(obj['actual_leads'] || obj['leads_actual'] || obj['actualleads']), plan: safeNum(obj['revised_leads'] || obj['leads_plan'] || obj['revisedleads']) },
					admissions: { actual: safeNum(obj['actual_admissions'] || obj['admissions_actual']), plan: safeNum(obj['revised_admissions'] || obj['admissions_plan']) },
					revenue: { actual: safeNum(obj['actual_revenue'] || obj['revenue_actual']), plan: safeNum(obj['revised_revenue'] || obj['revenue_plan']) },
					pl: { actual: safeNum(obj['actual_pl'] || obj['pl_actual']), plan: safeNum(obj['revised_pl'] || obj['pl_plan']) },
					spend: { actual: safeNum(obj['actual_spend'] || obj['spend_actual']), plan: safeNum(obj['revised_spend'] || obj['spend_plan']) },
				};

				// ensure numeric fields exist
				Object.keys(row.leads).forEach(k => row.leads[k] = Number(row.leads[k] || 0));
				Object.keys(row.admissions).forEach(k => row.admissions[k] = Number(row.admissions[k] || 0));
				Object.keys(row.revenue).forEach(k => row.revenue[k] = Number(row.revenue[k] || 0));
				Object.keys(row.pl).forEach(k => row.pl[k] = Number(row.pl[k] || 0));
				Object.keys(row.spend).forEach(k => row.spend[k] = Number(row.spend[k] || 0));

				return row;
			});
		}

		// initialize: use sample or sheet
		async function init() {
			console.log('Initializing dashboard...');
			try {
				if (USE_SAMPLE_DATA) {
					allData = sampleData.map(r => {
						// ensure monthYear -> month/year fields exist for sample data
						const [m, y] = (r.monthYear || '').split(' ');
						const monthMap = {'Jan':0,'Feb':1,'Mar':2,'Apr':3,'May':4,'Jun':5,'Jul':6,'Aug':7,'Sep':8,'Oct':9,'Nov':10,'Dec':11};
						return {
							...r,
							month: m || '',
							year: parseInt(y) || new Date().getFullYear(),
							monthIndex: monthMap[m] ?? 0
						};
					});
				} else {
					// fetch csv and parse
					document.getElementById('tableContainer').innerHTML = '<div class="loading">Loading data from Google Sheet...</div>';
					allData = await loadSheetData(SHEET_URL);
				}

				console.log('Data loaded:', allData.length, 'rows');
				document.getElementById('errorMessage').style.display = 'none';

				// Setup event listeners
				document.getElementById('durationType').onchange = function() {
					const type = this.value;
					document.getElementById('monthFilter').style.display = type === 'month' ? 'block' : 'none';
					document.getElementById('quarterFilter').style.display = type === 'quarter' ? 'block' : 'none';
					document.getElementById('yearFilter').style.display = (type === 'quarter' || type === 'year') ? 'block' : 'none';
				};

				populateFilters();
				applyFilters();
			} catch (err) {
				console.error('Init error:', err);
				const em = document.getElementById('errorMessage');
				em.textContent = 'Error loading data: ' + err.message;
				em.style.display = 'block';
				document.getElementById('tableContainer').innerHTML = '<div class="loading">Failed to load data</div>';
			}
		}

		function populateFilters() {
			// Month-Year dropdown (unique sorted by year then monthIndex)
			const monthYears = [...new Set(allData.map(r => r.monthYear))];
			// sort by year then monthIndex
			monthYears.sort((a,b) => {
				const aParts = a.split(' ');
				const bParts = b.split(' ');
				const ay = parseInt(aParts[aParts.length-1]) || 0;
				const by = parseInt(bParts[bParts.length-1]) || 0;
				if (ay !== by) return by - ay; // recent first
				// fallback compare month names using mapping
				const monthMap = {'Jan':0,'Feb':1,'Mar':2,'Apr':3,'May':4,'Jun':5,'Jul':6,'Aug':7,'Sep':8,'Oct':9,'Nov':10,'Dec':11};
				const am = (aParts[0]||'');
				const bm = (bParts[0]||'');
				return (monthMap[bm] ?? 0) - (monthMap[am] ?? 0);
			});
			const monthSelect = document.getElementById('monthYear');
			monthSelect.innerHTML = '<option value="">All Months</option>';
			monthYears.forEach(m => { const opt = document.createElement('option'); opt.value = m; opt.textContent = m; monthSelect.appendChild(opt); });

			// Year dropdown
			const years = [...new Set(allData.map(r => r.year))].sort((a,b)=>b-a);
			const yearSelect = document.getElementById('year');
			yearSelect.innerHTML = '<option value="">All Years</option>';
			years.forEach(y => { const opt = document.createElement('option'); opt.value = y; opt.textContent = y; yearSelect.appendChild(opt); });

			// Cluster dropdown
			const clusters = [...new Set(allData.map(r => r.cluster || ''))].filter(c=>c).sort();
			const clusterSelect = document.getElementById('cluster');
			clusterSelect.innerHTML = '<option value="">All Clusters</option>';
			clusters.forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.textContent = c; clusterSelect.appendChild(opt); });

			console.log('Filters populated');
		}

		function getQuarter(monthIndex) {
			if (monthIndex <= 2) return 'Q1';
			if (monthIndex <= 5) return 'Q2';
			if (monthIndex <= 8) return 'Q3';
			return 'Q4';
		}

		function applyFilters() {
			const durationType = document.getElementById('durationType').value;
			const selectedMonth = document.getElementById('monthYear').value;
			const selectedQuarter = document.getElementById('quarter').value;
			const selectedYear = document.getElementById('year').value;
			const selectedCluster = document.getElementById('cluster').value;

			let filtered = allData.filter(row => {
				if (selectedCluster && row.cluster !== selectedCluster) return false;
				if (durationType === 'month' && selectedMonth && row.monthYear !== selectedMonth) return false;
				if (durationType === 'quarter') {
					if (selectedYear && String(row.year) != String(selectedYear)) return false;
					if (selectedQuarter && getQuarter(row.monthIndex) !== selectedQuarter) return false;
				}
				if (durationType === 'year' && selectedYear && String(row.year) != String(selectedYear)) return false;
				return true;
			});

			// Aggregate by university
			const agg = {};
			filtered.forEach(row => {
				if (!agg[row.university]) {
					agg[row.university] = {
						university: row.university,
						leads: {actual: 0, plan: 0},
						admissions: {actual: 0, plan: 0},
						revenue: {actual: 0, plan: 0},
						pl: {actual: 0, plan: 0},
						spend: {actual: 0, plan: 0}
					};
				}
				const a = agg[row.university];
				a.leads.actual += Number(row.leads.actual || 0);
				a.leads.plan += Number(row.leads.plan || 0);
				a.admissions.actual += Number(row.admissions.actual || 0);
				a.admissions.plan += Number(row.admissions.plan || 0);
				a.revenue.actual += Number(row.revenue.actual || 0);
				a.revenue.plan += Number(row.revenue.plan || 0);
				a.pl.actual += Number(row.pl.actual || 0);
				a.pl.plan += Number(row.pl.plan || 0);
				a.spend.actual += Number(row.spend.actual || 0);
				a.spend.plan += Number(row.spend.plan || 0);
			});

			// Calculate CPL and ROAS per university
			filteredData = Object.values(agg).map(row => {
				row.cpl = {
					actual: row.leads.actual > 0 ? row.spend.actual / row.leads.actual : 0,
					plan: row.leads.plan > 0 ? row.spend.plan / row.leads.plan : 0
				};
				row.roas = {
					actual: row.spend.actual > 0 ? row.revenue.actual / row.spend.actual : 0,
					plan: row.spend.plan > 0 ? row.revenue.plan / row.spend.plan : 0
				};
				return row;
			});

			// Calculate totals
			totals = {
				leads: {actual: 0, plan: 0},
				admissions: {actual: 0, plan: 0},
				spend: {actual: 0, plan: 0},
				revenue: {actual: 0, plan: 0},
				pl: {actual: 0, plan: 0}
			};

			filteredData.forEach(row => {
				totals.leads.actual += row.leads.actual;
				totals.leads.plan += row.leads.plan;
				totals.admissions.actual += row.admissions.actual;
				totals.admissions.plan += row.admissions.plan;
				totals.spend.actual += row.spend.actual;
				totals.spend.plan += row.spend.plan;
				totals.revenue.actual += row.revenue.actual;
				totals.revenue.plan += row.revenue.plan;
				totals.pl.actual += row.pl.actual;
				totals.pl.plan += row.pl.plan;
			});

			totals.cpl = {
				actual: totals.leads.actual > 0 ? totals.spend.actual / totals.leads.actual : 0,
				plan: totals.leads.plan > 0 ? totals.spend.plan / totals.leads.plan : 0
			};
			totals.roas = {
				actual: totals.spend.actual > 0 ? totals.revenue.actual / totals.spend.actual : 0,
				plan: totals.spend.plan > 0 ? totals.revenue.plan / totals.spend.plan : 0
			};
			totals.convRate = {
				actual: totals.leads.actual > 0 ? (totals.admissions.actual / totals.leads.actual) * 100 : 0,
				plan: totals.leads.plan > 0 ? (totals.admissions.plan / totals.leads.plan) * 100 : 0
			};

			renderKPIs();
			renderTable();
		}

		function renderKPIs() {
			const kpis = [
				{ label: 'Leads', key: 'leads', format: 'number' },
				{ label: 'Spend', key: 'spend', format: 'currency' },
				{ label: 'CPL', key: 'cpl', format: 'currency' },
				{ label: 'P&L', key: 'pl', format: 'currency' },
				{ label: 'Admissions', key: 'admissions', format: 'number' },
				{ label: 'Revenue', key: 'revenue', format: 'currency' },
				{ label: 'Conversion Rate', key: 'convRate', format: 'percentage' },
				{ label: 'ROAS', key: 'roas', format: 'decimal' }
			];

			let html = '';
			kpis.forEach(kpi => {
				const actual = totals[kpi.key].actual;
				const plan = totals[kpi.key].plan;
				const achievement = plan > 0 ? (actual / plan) * 100 : 0;
				const bulletWidth = Math.min(Math.max(achievement, 0), 100);

				let bulletClass = actual > plan ? 'green' : actual < plan ? 'red' : 'grey';
				let actualDisplay, planDisplay;

				if (kpi.format === 'currency') {
					const formattedActual = actual.toLocaleString('en-IN', { maximumFractionDigits: 0, minimumFractionDigits: 0 });
					const formattedPlan = plan.toLocaleString('en-IN', { maximumFractionDigits: 0, minimumFractionDigits: 0 });
					actualDisplay = '₹' + formattedActual;
					planDisplay = '₹' + formattedPlan;
				} else if (kpi.format === 'percentage') {
					const formattedActual = actual.toLocaleString('en-IN', { maximumFractionDigits: 2, minimumFractionDigits: 2 });
					const formattedPlan = plan.toLocaleString('en-IN', { maximumFractionDigits: 2, minimumFractionDigits: 2 });
					actualDisplay = formattedActual + '%';
					planDisplay = formattedPlan + '%';
				} else if (kpi.format === 'decimal') {
					const formattedActual = actual.toLocaleString('en-IN', { maximumFractionDigits: 2, minimumFractionDigits: 2 });
					const formattedPlan = plan.toLocaleString('en-IN', { maximumFractionDigits: 2, minimumFractionDigits: 2 });
					actualDisplay = formattedActual;
					planDisplay = formattedPlan;
				} else {
					actualDisplay = Math.round(actual).toLocaleString('en-IN');
					planDisplay = Math.round(plan).toLocaleString('en-IN');
				}


				html += `
					<div class="kpi-card ${kpi.highlight ? 'highlight' : ''}">
						<div class="kpi-label">${kpi.label}</div>
						<div class="kpi-value">${actualDisplay}</div>
						<div class="kpi-plan">Plan: ${planDisplay}</div>
						<div class="bullet-chart">
							<div class="bullet-fill ${bulletClass}" style="width: ${bulletWidth}%"></div>
						</div>
						<div class="kpi-percentage ${bulletClass}">${achievement.toFixed(1)}%</div>
					</div>
				`;
			});

			document.getElementById('kpiSection').innerHTML = html;
		}

		function renderTable() {
		  if (filteredData.length === 0) {
		    document.getElementById('tableContainer').innerHTML =
		      '<div class="loading">No data for selected filters</div>';
		    return;
		  }
		
		  let html = `
		    <table id="mainTable">
		      <thead>
		        <tr>
		          <th>University 
		            <button class="sort-btn" onclick="sortTable(0, 'asc')">▲</button>
		            <button class="sort-btn" onclick="sortTable(0, 'desc')">▼</button>
		          </th>
		          <th>Leads 
		            <button class="sort-btn" onclick="sortTable(1, 'asc')">▲</button>
		            <button class="sort-btn" onclick="sortTable(1, 'desc')">▼</button>
		          </th>
		          <th>Admissions 
		            <button class="sort-btn" onclick="sortTable(2, 'asc')">▲</button>
		            <button class="sort-btn" onclick="sortTable(2, 'desc')">▼</button>
		          </th>
		          <th>Spend 
		            <button class="sort-btn" onclick="sortTable(3, 'asc')">▲</button>
		            <button class="sort-btn" onclick="sortTable(3, 'desc')">▼</button>
		          </th>
		          <th>Revenue 
		            <button class="sort-btn" onclick="sortTable(4, 'asc')">▲</button>
		            <button class="sort-btn" onclick="sortTable(4, 'desc')">▼</button>
		          </th>
		          <th>CPL 
		            <button class="sort-btn" onclick="sortTable(5, 'asc')">▲</button>
		            <button class="sort-btn" onclick="sortTable(5, 'desc')">▼</button>
		          </th>
		          <th>P&L 
		            <button class="sort-btn" onclick="sortTable(6, 'asc')">▲</button>
		            <button class="sort-btn" onclick="sortTable(6, 'desc')">▼</button>
		          </th>
		          <th>ROAS 
		            <button class="sort-btn" onclick="sortTable(7, 'asc')">▲</button>
		            <button class="sort-btn" onclick="sortTable(7, 'desc')">▼</button>
		          </th>
		        </tr>
		      </thead>
		      <tbody>
		  `;
		
		  filteredData.forEach(row => {
		    const roasPlan = row.roas.plan || 0;
		    let roasClass = 'red';
		    if (roasPlan === 0) roasClass = 'amber';
		    else
		      roasClass =
		        row.roas.actual >= roasPlan
		          ? 'green'
		          : (roasPlan - row.roas.actual) / roasPlan <= 0.2
		          ? 'amber'
		          : 'red';
		
		    html += `
		      <tr>
		        <td>${row.university || '-'}</td>
		        <td>${createCell(row.leads, 'integer')}</td>
		        <td>${createCell(row.admissions, 'integer')}</td>
		        <td>${createCell(row.spend, 'currency')}</td>
		        <td>${createCell(row.revenue, 'currency')}</td>
		        <td>${createCell(row.cpl, 'currency')}</td>
		        <td>${createCell(row.pl, 'currency')}</td>
		        <td class="roas-cell ${roasClass}">${createCell(row.roas, 'decimal')}</td>
		      </tr>`;
		  });
		
		  const totalRoasPlan = totals.roas.plan || 0;
		  let totalRoasClass = 'red';
		  if (totalRoasPlan === 0) totalRoasClass = 'amber';
		  else
		    totalRoasClass =
		      totals.roas.actual >= totalRoasPlan
		        ? 'green'
		        : (totalRoasPlan - totals.roas.actual) / totalRoasPlan <= 0.2
		        ? 'amber'
		        : 'red';
		
		  html += `
		      </tbody>
		      <tfoot>
		        <tr class="total-row">
		          <td>Total</td>
		          <td>${createCell(totals.leads, 'integer')}</td>
		          <td>${createCell(totals.admissions, 'integer')}</td>
		          <td>${createCell(totals.spend, 'currency')}</td>
		          <td>${createCell(totals.revenue, 'currency')}</td>
		          <td>${createCell(totals.cpl, 'currency')}</td>
		          <td>${createCell(totals.pl, 'currency')}</td>
		          <td class="roas-cell ${totalRoasClass}">${createCell(totals.roas, 'decimal')}</td>
		        </tr>
		      </tfoot>
		    </table>
		  `;
		
		  document.getElementById('tableContainer').innerHTML = html;
		  document.getElementById('tableWrapper').style.maxHeight = '650px';
	
		}

	

		function sortTable(colIndex, direction) {
		  const table = document.getElementById("mainTable");
		  if (!table) return;
		
		  const tbody = table.querySelector("tbody");
		  let rows = Array.from(tbody.querySelectorAll("tr"));
		
		  // Exclude total row from sorting
		  const totalRow = rows.pop();
		
		  const isNumeric = (val) => !isNaN(parseFloat(val.replace(/[^0-9.\-]/g, "")));
		
		  rows.sort((a, b) => {
		    let aText = a.children[colIndex].innerText.trim();
		    let bText = b.children[colIndex].innerText.trim();
		
		    const aVal = isNumeric(aText) ? parseFloat(aText.replace(/[^0-9.\-]/g, "")) : aText.toLowerCase();
		    const bVal = isNumeric(bText) ? parseFloat(bText.replace(/[^0-9.\-]/g, "")) : bText.toLowerCase();
		
		    if (aVal < bVal) return direction === "asc" ? -1 : 1;
		    if (aVal > bVal) return direction === "asc" ? 1 : -1;
		    return 0;
		  });
		
		  tbody.innerHTML = "";
		  rows.forEach(r => tbody.appendChild(r));
		  tbody.appendChild(totalRow); // Keep Total at bottom
		}



		function createCell(data, format = 'number') {
		  const variance = data.plan > 0 ? ((data.actual - data.plan) / data.plan) * 100 : 0;
		  const varClass = variance > 0 ? 'positive' : variance < 0 ? 'negative' : 'neutral';
		  const arrow = variance > 0 ? '↗ +' : variance < 0 ? '↘ ' : '↔ ';
		
		  let actualDisplay, planDisplay;
		
		  // Use Indian-style comma formatting with 1 decimal
		  const formattedActual = data.actual.toLocaleString('en-IN', {
		    minimumFractionDigits: 2,
		    maximumFractionDigits: 2
		  });
		  const formattedPlan = data.plan.toLocaleString('en-IN', {
		    minimumFractionDigits: 2,
		    maximumFractionDigits: 2
		  });
		
		  if (format === 'currency') {
		    actualDisplay = '₹' + data.actual.toLocaleString('en-IN', {
		    minimumFractionDigits: 0,
		    maximumFractionDigits: 0
		  });
		    planDisplay = '₹' + data.plan.toLocaleString('en-IN', {
		    minimumFractionDigits: 0,
		    maximumFractionDigits: 0
		  });
		  } else if (format === 'decimal') {
		    actualDisplay = formattedActual;
		    planDisplay = formattedPlan;
		  } else if (format === 'percentage') {
		    actualDisplay = formattedActual + '%';
		    planDisplay = formattedPlan + '%';
		  } else if (format === 'integer') {
		    actualDisplay =  data.actual.toLocaleString('en-IN', {
		    minimumFractionDigits: 0,
		    maximumFractionDigits: 0
		  });
		    planDisplay = data.plan.toLocaleString('en-IN', {
		    minimumFractionDigits: 0,
		    maximumFractionDigits: 0
		  });
		  } else {
		    actualDisplay = formattedActual;
		    planDisplay = formattedPlan;
		  }
		
		  return `
		    <div class="metric-cell">
		      <span class="actual-value">${actualDisplay}</span>
		      <span class="plan-value">Plan: ${planDisplay}</span>
		      <span class="variance ${varClass}">${arrow}${Math.abs(variance).toFixed(1)}%</span>
		    </div>
		  `;
		}

		

		// Initialize on window load
		window.onload = init;

		// ====== PERFORMANCE TREND CHART (REAL DATA) ======
		let performanceChartInstance = null;
		
		// Helper to get filtered monthly data from allData
		function getMonthlyMetrics(metricKey) {
		  const monthly = {};
		
		  allData.forEach(row => {
		    const month = row.month;
		    if (!monthly[month]) {
		      monthly[month] = {
		        actual: 0,
		        plan: 0,
		        spendActual: 0,
		        spendPlan: 0,
		        leadsActual: 0,
		        leadsPlan: 0,
		        admissionsActual: 0,
		        admissionsPlan: 0,
		        revenueActual: 0,
		        revenuePlan: 0,
		      };
		    }
		
		    monthly[month].spendActual += +row.spend.actual;
		    monthly[month].spendPlan += +row.spend.plan;
		    monthly[month].leadsActual += +row.leads.actual;
		    monthly[month].leadsPlan += +row.leads.plan;
		    monthly[month].admissionsActual += +row.admissions.actual;
		    monthly[month].admissionsPlan += +row.admissions.plan;
		    monthly[month].revenueActual += +row.revenue.actual;
		    monthly[month].revenuePlan += +row.revenue.plan;
		
		    switch (metricKey) {
		      case "Leads":
		        monthly[month].actual = monthly[month].leadsActual;
		        monthly[month].plan = monthly[month].leadsPlan;
		        break;
		      case "Admissions":
		        monthly[month].actual = monthly[month].admissionsActual;
		        monthly[month].plan = monthly[month].admissionsPlan;
		        break;
		      case "Revenue":
		        monthly[month].actual = monthly[month].revenueActual;
		        monthly[month].plan = monthly[month].revenuePlan;
		        break;
		      case "Spend":
		        monthly[month].actual = monthly[month].spendActual;
		        monthly[month].plan = monthly[month].spendPlan;
		        break;
		      case "P&L":
		        monthly[month].actual = monthly[month].revenueActual - monthly[month].spendActual;
		        monthly[month].plan = monthly[month].revenuePlan - monthly[month].spendPlan;
		        break;
		      case "CPL":
		        monthly[month].actual = monthly[month].leadsActual > 0 ? (monthly[month].spendActual / monthly[month].leadsActual) : 0;
		        monthly[month].plan = monthly[month].leadsPlan > 0 ? (monthly[month].spendPlan / monthly[month].leadsPlan) : 0;
		        break;
		      case "Conversion Rate":
		        monthly[month].actual = monthly[month].leadsActual > 0 ? (monthly[month].admissionsActual / monthly[month].leadsActual) * 100 : 0;
		        monthly[month].plan = monthly[month].leadsPlan > 0 ? (monthly[month].admissionsPlan / monthly[month].leadsPlan) * 100 : 0;
		        break;
		      case "ROAS":
		        monthly[month].actual = monthly[month].spendActual > 0 ? (monthly[month].revenueActual / monthly[month].spendActual) : 0;
		        monthly[month].plan = monthly[month].spendPlan > 0 ? (monthly[month].revenuePlan / monthly[month].spendPlan) : 0;
		        break;
		    }
		  });
		
		  const monthsOrder = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
		  const actualArr = [];
		  const planArr = [];
		  const monthLabels = [];
		
		  monthsOrder.forEach(m => {
		    if (monthly[m]) {
		      monthLabels.push(m);
		      actualArr.push(monthly[m].actual);
		      planArr.push(monthly[m].plan);
		    }
		  });
		
		  return { monthLabels, actualArr, planArr };
		}
		
		// Function to format axis values
		function formatMetricValue(value, metric) {
		  if (["Revenue", "Spend", "P&L"].includes(metric)) {
		    return "₹" + value.toLocaleString("en-IN", { maximumFractionDigits: 0 });
		  } else if (metric === "Conversion Rate") {
		    return value.toFixed(2) + "%";
		  } else if (metric === "ROAS") {
		    return value.toFixed(2);
		  } else {
		    return value.toLocaleString("en-IN", { maximumFractionDigits: 0 });
		  }
		}
		
		// Function to draw chart
		function drawPerformanceTrend(metric, duration) {
		  const { monthLabels, actualArr, planArr } = getMonthlyMetrics(metric);
		
		  const displayCount = duration === 3 ? 3 : duration === 6 ? 6 : duration === 7 ? 7 : 12;
		  const labels = monthLabels.slice(0, displayCount);
		  const actualValues = actualArr.slice(0, displayCount);
		  const planValues = planArr.slice(0, displayCount);
		
		  const ctx = document.getElementById("performanceChart").getContext("2d");
		  if (performanceChartInstance) performanceChartInstance.destroy();
		
		  const gradient = ctx.createLinearGradient(0, 0, 0, 400);
		  gradient.addColorStop(0, "rgba(37,99,235,0.35)");
		  gradient.addColorStop(1, "rgba(37,99,235,0.05)");
		
		  performanceChartInstance = new Chart(ctx, {
		    type: "line",
		    data: {
		      labels,
		      datasets: [
		        {
		          label: `Actual ${metric}`,
		          data: actualValues,
		          borderColor: "#2563eb",
		          backgroundColor: gradient,
		          fill: true,
		          tension: 0.4,
		          borderWidth: 2.2,
		          pointRadius: 4,
		          pointBackgroundColor: "#2563eb"
		        },
		        {
		          label: `Planned ${metric}`,
		          data: planValues,
		          borderColor: "#93c5fd",
		          borderDash: [5, 5],
		          tension: 0.4,
		          borderWidth: 1.8,
		          pointRadius: 3,
		          pointBackgroundColor: "#93c5fd"
		        }
		      ]
		    },
		    options: {
		      responsive: true,
		      maintainAspectRatio: false,
		      plugins: {
		        legend: {
		          position: "bottom",
		          labels: { usePointStyle: true, boxWidth: 8, padding: 15 }
		        },
		        tooltip: {
		          backgroundColor: "#1e293b",
		          titleColor: "#fff",
		          bodyColor: "#f8fafc",
		          callbacks: {
		            label: function (context) {
		              return `${context.dataset.label}: ${formatMetricValue(context.parsed.y, metric)}`;
		            }
		          }
		        }
		      },
		      scales: {
		        y: {
		          ticks: {
		            callback: val => formatMetricValue(val, metric),
		            color: "#374151"
		          },
		          grid: { color: "#f3f4f6" }
		        },
		        x: {
		          ticks: { color: "#6b7280" },
		          grid: { display: false }
		        }
		      }
		    }
		  });
		}
		
		// Wait for allData before initializing
		function initPerformanceChartWhenReady() {
		  const interval = setInterval(() => {
		    if (typeof allData !== "undefined" && allData.length > 0) {
		      clearInterval(interval);
		
		      // Default selections
		      const metricSelect = document.getElementById("metricSelect");
		      const durationSelect = document.getElementById("durationSelect");
		
		      const defaultMetric = metricSelect?.value || "Revenue";
		      const defaultDuration = parseInt(durationSelect?.value) || 7;
		
		      // Render default chart
		      drawPerformanceTrend(defaultMetric, defaultDuration);
		
		      // Event listeners
		      metricSelect.addEventListener("change", () => {
		        const metric = metricSelect.value;
		        const duration = parseInt(durationSelect.value);
		        drawPerformanceTrend(metric, duration);
		      });
		
		      durationSelect.addEventListener("change", () => {
		        const metric = metricSelect.value;
		        const duration = parseInt(durationSelect.value);
		        drawPerformanceTrend(metric, duration);
		      });
		    }
		  }, 300);
		}
		
		document.addEventListener("DOMContentLoaded", initPerformanceChartWhenReady);


		
		
				// ======= YEAR-TO-DATE (YTD) PERFORMANCE CHART =======
		// ======= YEAR-TO-DATE (YTD) PERFORMANCE CHART =======
		let ytdChartInstance = null;
		let currentMetricKey = "Revenue"; // default metric
		const monthsOrder = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
		
		// ========== POPULATE YEAR DROPDOWN ==========
		function populateYearDropdown() {
		  const yearSelect = document.getElementById("yearSelect");
		  if (!yearSelect || !allData || allData.length === 0) return;
		
		  const years = [...new Set(allData.map(row => row.year || new Date(row.date).getFullYear()))]
			.filter(y => y) // remove undefined
			.sort((a, b) => b - a);
		
		  if (years.length === 0) return;
		
		  yearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join("");
		  yearSelect.value = years[0]; // default to latest year
		}
		
		// ========== FUNCTION TO GET CUMULATIVE DATA (WITHIN SELECTED YEAR) ==========
		function getYTDMonthlyMetrics(metricKey, selectedYear) {
		  const monthly = {};
		
		  // Filter for selected year only
		  const filteredData = allData.filter(row => {
			const year = row.year || new Date(row.date).getFullYear();
			return year === selectedYear;
		  });
		
		  filteredData.forEach(row => {
			const month = row.month;
			if (!monthly[month]) {
			  monthly[month] = {
				spendActual: 0, spendPlan: 0,
				leadsActual: 0, leadsPlan: 0,
				admissionsActual: 0, admissionsPlan: 0,
				revenueActual: 0, revenuePlan: 0
			  };
			}
		
			monthly[month].spendActual += Number(row.spend?.actual || 0);
			monthly[month].spendPlan  += Number(row.spend?.plan  || 0);
			monthly[month].leadsActual += Number(row.leads?.actual || 0);
			monthly[month].leadsPlan  += Number(row.leads?.plan  || 0);
			monthly[month].admissionsActual += Number(row.admissions?.actual || 0);
			monthly[month].admissionsPlan  += Number(row.admissions?.plan  || 0);
			monthly[month].revenueActual += Number(row.revenue?.actual || 0);
			monthly[month].revenuePlan  += Number(row.revenue?.plan  || 0);
		  });
		
		  const monthLabels = [];
		  const actualArr = [];
		  const planArr = [];
		
		  let cum = {
			spendActual: 0, spendPlan: 0,
			leadsActual: 0, leadsPlan: 0,
			admissionsActual: 0, admissionsPlan: 0,
			revenueActual: 0, revenuePlan: 0
		  };
		
		  monthsOrder.forEach(m => {
			if (!monthly[m]) return;
		
			const mData = monthly[m];
			cum.spendActual += mData.spendActual;
			cum.spendPlan   += mData.spendPlan;
			cum.leadsActual += mData.leadsActual;
			cum.leadsPlan   += mData.leadsPlan;
			cum.admissionsActual += mData.admissionsActual;
			cum.admissionsPlan   += mData.admissionsPlan;
			cum.revenueActual += mData.revenueActual;
			cum.revenuePlan   += mData.revenuePlan;
		
			let actual = 0, plan = 0;
		
			switch (metricKey) {
			  case "Leads":
				actual = cum.leadsActual;
				plan   = cum.leadsPlan;
				break;
			  case "Admissions":
				actual = cum.admissionsActual;
				plan   = cum.admissionsPlan;
				break;
			  case "Revenue":
				actual = cum.revenueActual;
				plan   = cum.revenuePlan;
				break;
			  case "Spend":
				actual = cum.spendActual;
				plan   = cum.spendPlan;
				break;
			  case "P&L":
				actual = cum.revenueActual - cum.spendActual;
				plan   = cum.revenuePlan - cum.spendPlan;
				break;
			  case "CPL":
				actual = cum.leadsActual > 0 ? (cum.spendActual / cum.leadsActual) : 0;
				plan   = cum.leadsPlan   > 0 ? (cum.spendPlan   / cum.leadsPlan)   : 0;
				break;
			  case "Conversion Rate":
				actual = cum.leadsActual > 0 ? (cum.admissionsActual / cum.leadsActual) * 100 : 0;
				plan   = cum.leadsPlan   > 0 ? (cum.admissionsPlan   / cum.leadsPlan)   * 100 : 0;
				break;
			  case "ROAS":
				actual = cum.spendActual > 0 ? (cum.revenueActual / cum.spendActual) : 0;
				plan   = cum.spendPlan   > 0 ? (cum.revenuePlan   / cum.spendPlan)   : 0;
				break;
			}
		
			monthLabels.push(m);
			actualArr.push(actual);
			planArr.push(plan);
		  });
		
		  return { monthLabels, actualArr, planArr };
		}
		
		// ========== FORMAT VALUES ==========
		function formatMetricValue(value, metricKey) {
		  if (["CPL", "Revenue", "Spend", "P&L", "Leads", "Admissions"].includes(metricKey)) {
			return value.toLocaleString("en-IN", { maximumFractionDigits: 0, minimumFractionDigits: 0 });
		  }
		  if (["Conversion Rate", "ROAS"].includes(metricKey)) {
			return value.toLocaleString("en-IN", { maximumFractionDigits: 2, minimumFractionDigits: 2 });
		  }
		  return value;
		}
		
		// ========== RENDER CHART ==========
		function renderYTDChart(metricKey, selectedYear) {
		  const ctx = document.getElementById("ytdPerformanceChart").getContext("2d");
		  const { monthLabels, actualArr, planArr } = getYTDMonthlyMetrics(metricKey, selectedYear);
		
		  if (ytdChartInstance) ytdChartInstance.destroy();
		
		  ytdChartInstance = new Chart(ctx, {
			type: "bar",
			data: {
			  labels: monthLabels,
			  datasets: [
				{
				  label: "Planned",
				  data: planArr,
				  backgroundColor: "#93c5fd",
				  borderRadius: 6,
				  barThickness: 20
				},
				{
				  label: "Actual",
				  data: actualArr,
				  backgroundColor: "#3b82f6",
				  borderRadius: 6,
				  barThickness: 20
				},
				{
				  type: "line",
				  label: "Actual Trend",
				  data: actualArr,
				  borderColor: "#10b981",
				  tension: 0.4,
				  fill: false,
				  pointRadius: 4,
				  pointBackgroundColor: "#10b981",
				  borderWidth: 2
				}
			  ]
			},
			options: {
			  responsive: true,
			  maintainAspectRatio: false,
			  interaction: { mode: "index", intersect: false },
			  plugins: {
				legend: {
				  position: "bottom",
				  labels: { usePointStyle: true, boxWidth: 8, padding: 15 }
				},
				tooltip: {
				  backgroundColor: "#1e293b",
				  titleColor: "#fff",
				  bodyColor: "#f8fafc",
				  callbacks: {
					label: function (context) {
					  const label = context.dataset.label || "";
					  return `${label}: ${formatMetricValue(context.parsed.y, metricKey)}`;
					}
				  }
				}
			  },
			  scales: {
				y: {
				  ticks: {
					color: "#374151",
					callback: val => formatMetricValue(val, metricKey)
				  },
				  grid: { color: "#f3f4f6" }
				},
				x: {
				  ticks: { color: "#6b7280" },
				  grid: { display: false }
				}
			  }
			}
		  });
		}
		
		// ========== SAFE INITIALIZATION (Wait for allData) ==========
		function initYTDChartWhenReady() {
		  const interval = setInterval(() => {
			if (typeof allData !== "undefined" && allData.length > 0) {
			  clearInterval(interval);
			  populateYearDropdown();
		
			  const metricSelect = document.getElementById("ytdMetricSelect");
			  const yearSelect = document.getElementById("yearSelect");
		
			  currentMetricKey = metricSelect?.value || "Revenue";
			  const defaultYear = parseInt(yearSelect?.value) || new Date().getFullYear();
		
			  renderYTDChart(currentMetricKey, defaultYear);
		
			  metricSelect.addEventListener("change", () => {
				currentMetricKey = metricSelect.value;
				renderYTDChart(currentMetricKey, parseInt(yearSelect.value));
			  });
		
			  yearSelect.addEventListener("change", () => {
				renderYTDChart(currentMetricKey, parseInt(yearSelect.value));
			  });
			}
		  }, 300);
		}
		
		document.addEventListener("DOMContentLoaded", initYTDChartWhenReady);
		



	</script>
</body>
</html>
