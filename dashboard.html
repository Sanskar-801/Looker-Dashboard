<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>University Performance Dashboard</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}
		
		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
			background: #f5f5f5;
			padding: 20px;
		}

		.dashboard-container {
			max-width: 1600px;
			margin: 0 auto;
		}

		.filters-section {
			background: white;
			border-radius: 8px;
			padding: 20px;
			margin-bottom: 20px;
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
		}

		.filters-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 15px;
			align-items: end;
		}

		.filter-group {
			display: flex;
			flex-direction: column;
		}

		.filter-label {
			font-size: 12px;
			font-weight: 600;
			color: #495057;
			margin-bottom: 6px;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}

		select {
			padding: 10px 12px;
			border: 1px solid #ced4da;
			border-radius: 6px;
			font-size: 14px;
			color: #495057;
			background-color: white;
			cursor: pointer;
			transition: border-color 0.2s;
		}

		select:hover {
			border-color: #80bdff;
		}

		select:focus {
			outline: none;
			border-color: #007bff;
			box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
		}

		.apply-button {
			padding: 10px 24px;
			background: #007bff;
			color: white;
			border: none;
			border-radius: 6px;
			font-size: 14px;
			font-weight: 600;
			cursor: pointer;
			transition: background 0.2s;
		}

		.apply-button:hover {
			background: #0056b3;
		}

		.apply-button:active {
			transform: scale(0.98);
		}

		.loading {
			text-align: center;
			padding: 40px;
			color: #6c757d;
		}

		.error {
			background: #f8d7da;
			color: #721c24;
			padding: 15px;
			border-radius: 6px;
			margin-bottom: 20px;
		}
		
		.table-container {
			background: white;
			border-radius: 8px;
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
			overflow-x: auto;
		}
		
		table {
			width: 100%;
			border-collapse: collapse;
			min-width: 1100px;
		}
		
		thead {
			background: #f8f9fa;
			border-bottom: 2px solid #dee2e6;
			position: sticky;
			top: 0;
			z-index: 10;
		}
		
		th {
			padding: 12px 16px;
			text-align: left;
			font-weight: 600;
			font-size: 13px;
			color: #495057;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}
		
		th:first-child {
			padding-left: 24px;
		}
		
		tbody tr {
			border-bottom: 1px solid #e9ecef;
			transition: background-color 0.2s;
		}
		
		tbody tr:hover {
			background-color: #f8f9fa;
		}
		
		tbody tr:last-child {
			border-bottom: none;
		}
		
		td {
			padding: 16px;
			vertical-align: middle;
		}
		
		td:first-child {
			padding-left: 24px;
			font-weight: 500;
			color: #212529;
		}
		
		.metric-cell {
			line-height: 1.6;
		}
		
		.actual-value {
			font-size: 18px;
			font-weight: 600;
			color: #212529;
			display: block;
			margin-bottom: 4px;
		}
		
		.plan-value {
			font-size: 11px;
			color: #6c757d;
			display: block;
			margin-bottom: 4px;
		}
		
		.variance {
			font-size: 12px;
			font-weight: 500;
			display: block;
		}
		
		.variance.positive { color: #00C853; }
		.variance.negative { color: #FF5252; }
		.variance.neutral { color: #9E9E9E; }
		
		/* Updated ROAS styles: semi-transparent backgrounds and bold text */
		.roas-cell {
			background-color: rgba(0, 0, 0, 0.03);
			font-weight: 700;
			text-align: center;
		}
		/* ROAS: color by Actual vs Revised (Plan) */
		.roas-cell.green { background-color: rgba(16, 185, 129, 0.16); color: #065F46; }
		.roas-cell.amber { background-color: rgba(245, 158, 11, 0.18); color: #7C2D12; }
		.roas-cell.red { background-color: rgba(239, 68, 68, 0.15); color: #7F1D1D; }
		/* Ensure inner content inherits the ROAS cell color for visibility */
		.roas-cell .actual-value,
		.roas-cell .plan-value,
		.roas-cell .variance { color: inherit; }
		
		.total-row {
			background: #f8f9fa;
			font-weight: 600;
			border-top: 2px solid #dee2e6;
		}
		
		.total-row td { padding: 18px 16px; }

		.info-banner {
			background: #d1ecf1;
			color: #0c5460;
			padding: 12px 20px;
			border-radius: 6px;
			margin-bottom: 20px;
			font-size: 14px;
		}

		.cluster-badge {
			display: inline-block;
			padding: 4px 10px;
			border-radius: 12px;
			font-size: 11px;
			font-weight: 600;
			background: #e9ecef;
			color: #495057;
		}
		
		@media (max-width: 768px) {
			body { padding: 10px; }
			th, td { padding: 10px 8px; font-size: 12px; }
			.actual-value { font-size: 16px; }
			.filters-grid { grid-template-columns: 1fr; }
		}
	</style>
</head>
<body>
	<div class="dashboard-container">
		<!-- Filters Section -->
		<div class="filters-section">
			<div class="filters-grid">
				<div class="filter-group">
					<label class="filter-label">Duration Type</label>
					<select id="durationType">
						<option value="month">Monthly</option>
						<option value="quarter">Quarterly</option>
						<option value="year">Yearly</option>
						<option value="all">All Time</option>
					</select>
				</div>
				
				<div class="filter-group" id="monthFilter">
					<label class="filter-label">Month & Year</label>
					<select id="monthYear">
						<option value="">All Months</option>
					</select>
				</div>

				<div class="filter-group" id="quarterFilter" style="display:none;">
					<label class="filter-label">Quarter</label>
					<select id="quarter">
						<option value="">All Quarters</option>
						<option value="Q1">Q1 (Jan-Mar)</option>
						<option value="Q2">Q2 (Apr-Jun)</option>
						<option value="Q3">Q3 (Jul-Sep)</option>
						<option value="Q4">Q4 (Oct-Dec)</option>
					</select>
				</div>
				
				<div class="filter-group" id="yearFilter" style="display:none;">
					<label class="filter-label">Year</label>
					<select id="year">
						<option value="">All Years</option>
					</select>
				</div>

				<div class="filter-group">
					<label class="filter-label">Cluster</label>
					<select id="cluster">
						<option value="">All Clusters</option>
					</select>
				</div>

				<div class="filter-group">
					<button class="apply-button" onclick="applyFilters()">Apply Filters</button>
				</div>
			</div>
		</div>

		<!-- Info Banner -->
		<div class="info-banner" id="infoBanner" style="display:none;">
			Loading data from Google Sheets...
		</div>

		<div id="errorMessage" class="error" style="display:none;"></div>

		<!-- Table Section -->
		<div class="table-container" id="tableContainer">
			<div class="loading">Loading data...</div>
		</div>
	</div>

	<script>
		// ============================================
		// CONFIGURATION SECTION - CHOOSE YOUR METHOD
		// ============================================
		
		// METHOD 1: Use Sample Data (for testing)
		const USE_SAMPLE_DATA = false; // Set to false when ready to connect to real data
		
		// METHOD 2: Google Sheets API (for domain-restricted sheets)
		const USE_API = false; // Set to true if using API method
		const API_KEY = 'YOUR_API_KEY_HERE'; // Get from Google Cloud Console
		const SHEET_ID = 'YOUR_SHEET_ID'; // From your sheet URL
		const SHEET_NAME = 'Sheet1'; // Your sheet tab name
		
		// METHOD 3: Public CSV URL (only works if sheet is publicly accessible)
		const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTEVY1wjKKOySULMlKauINBg0w6EFeqptOkg0JTEotpZljSFI-XSLiVyDqBrV1p70DKS9_PJ5y39kjq/pub?output=csv';
		
		// ============================================
		
		let allData = [];
		let filteredData = [];

		// Handle duration type change
		document.getElementById('durationType').addEventListener('change', function() {
			const type = this.value;
			document.getElementById('monthFilter').style.display = type === 'month' ? 'block' : 'none';
			document.getElementById('quarterFilter').style.display = type === 'quarter' ? 'block' : 'none';
			document.getElementById('yearFilter').style.display = (type === 'quarter' || type === 'year') ? 'block' : 'none';
		});

		// Parse month-year from "Apr 2024" format
		function parseMonthYear(monthYearStr) {
			const months = {
				'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
				'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11,
				'January': 0, 'February': 1, 'March': 2, 'April': 3, 'May': 4, 'June': 5,
				'July': 6, 'August': 7, 'September': 8, 'October': 9, 'November': 10, 'December': 11
			};
			
			const parts = monthYearStr.trim().split(' ');
			if (parts.length >= 2) {
				const month = parts[0];
				const year = parseInt(parts[1]);
				return { month, year, monthIndex: months[month] || 0 };
			}
			return { month: '', year: 0, monthIndex: 0 };
		}

		function getQuarter(monthIndex) {
			if (monthIndex >= 0 && monthIndex <= 2) return 'Q1';
			if (monthIndex >= 3 && monthIndex <= 5) return 'Q2';
			if (monthIndex >= 6 && monthIndex <= 8) return 'Q3';
			return 'Q4';
		}

		// Sample data for testing (replace with your actual data structure)
		const SAMPLE_DATA = [
			['AMET', 'Cluster A', 'Apr 2024', 1850, 1700, 295, 272, 885000, 816000, 266000, 245000, 245000, 255000, 132, 150, 831, 938, 3.6, 3.2, 15.9, 16.0],
			['AMET', 'Cluster A', 'May 2024', 920, 850, 147, 136, 588000, 544000, 176000, 163000, 142000, 145000, 154, 171, 966, 1066, 4.1, 3.8, 16.0, 16.0],
			['AMET', 'Cluster A', 'Jun 2024', 1120, 1050, 178, 168, 445000, 420000, 134000, 126000, 125000, 130000, 112, 124, 702, 774, 3.6, 3.2, 15.9, 16.0],
			['University B', 'Cluster B', 'Apr 2024', 890, 800, 142, 128, 355000, 320000, 107000, 96000, 118000, 120000, 133, 150, 831, 938, 3.0, 2.7, 16.0, 16.0],
			['University B', 'Cluster B', 'May 2024', 670, 600, 110, 96, 337000, 300000, 101000, 90000, 115000, 100000, 172, 167, 1045, 1042, 2.9, 3.0, 16.4, 16.0],
			['University C', 'Cluster C', 'Apr 2024', 750, 700, 120, 110, 400000, 380000, 150000, 140000, 130000, 135000, 173, 193, 1083, 1227, 3.1, 2.8, 16.0, 15.7],
		];

		// Fetch data from Google Sheets
		async function fetchSheetData() {
			const infoBanner = document.getElementById('infoBanner');
			const errorMessage = document.getElementById('errorMessage');
			
			infoBanner.style.display = 'block';
			infoBanner.textContent = 'Loading data from Google Sheets...';
			errorMessage.style.display = 'none';

			try {
				let csvText;
				
				if (USE_SAMPLE_DATA) {
					// Use sample data for demo
					csvText = SAMPLE_DATA.map(row => row.join(',')).join('\n');
					infoBanner.textContent = 'Using sample data (configure Google Sheets connection)';
				} else if (USE_API) {
					// Method 1: Google Sheets API (requires public sheet or API key)
					const apiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;
					const response = await fetch(apiUrl);
					const data = await response.json();
					
					if (data.values) {
						csvText = data.values.map(row => row.join(',')).join('\n');
					} else {
						throw new Error('No data returned from API');
					}
				} else {
					// Method 2: Direct CSV fetch (requires publicly published sheet)
					const response = await fetch(SHEET_URL);
					csvText = await response.text();
				}
				
				// Parse CSV
				const rows = csvText.split('\n').map(row => {
					const cols = [];
					let current = '';
					let inQuotes = false;
					
					for (let char of row) {
						if (char === '"') {
							inQuotes = !inQuotes;
						} else if (char === ',' && !inQuotes) {
							cols.push(current.trim());
							current = '';
						} else {
							current += char;
						}
					}
					cols.push(current.trim());
					return cols;
				});

				// Skip header row
				allData = rows.slice(1).filter(row => row[0] && row[0].trim() !== '').map(row => {
					const parseNumber = (str) => {
						if (!str || str === '') return 0;
						// Remove currency symbols and commas
						return parseFloat(str.replace(/[₹,]/g, '')) || 0;
					};

					const parsePercentage = (str) => {
						if (!str || str === '') return 0;
						return parseFloat(str.replace('%', '')) || 0;
					};

					const monthYearInfo = parseMonthYear(row[2] || '');

					return {
						university: row[0] || '',
						cluster: row[1] || '',
						monthYear: row[2] || '',
						month: monthYearInfo.month,
						year: monthYearInfo.year,
						monthIndex: monthYearInfo.monthIndex,
						leads: { actual: parseNumber(row[3]), plan: parseNumber(row[4]) },
						admissions: { actual: parseNumber(row[5]), plan: parseNumber(row[6]) },
						revenue: { actual: parseNumber(row[7]), plan: parseNumber(row[8]) },
						pl: { actual: parseNumber(row[9]), plan: parseNumber(row[10]) },
						spend: { actual: parseNumber(row[11]), plan: parseNumber(row[12]) },
						cpl: { actual: parseNumber(row[13]), plan: parseNumber(row[14]) },
						cpa: { actual: parseNumber(row[15]), plan: parseNumber(row[16]) },
						roas: { actual: parseNumber(row[17]), plan: parseNumber(row[18]) },
						convRate: { actual: parsePercentage(row[19]), plan: parsePercentage(row[20]) }
					};
				});

				// Populate filter dropdowns
				populateFilters();
				infoBanner.style.display = 'none';
				applyFilters();
				
			} catch (error) {
				console.error('Error fetching data:', error);
				errorMessage.textContent = `Error loading data: ${error.message}. Please ensure the sheet is published correctly.`;
				errorMessage.style.display = 'block';
				infoBanner.style.display = 'none';
				document.getElementById('tableContainer').innerHTML = '<div class="loading">Failed to load data</div>';
			}
		}

		function populateFilters() {
			// Populate month-year dropdown
			const monthYears = [...new Set(allData.map(row => row.monthYear))].sort();
			const monthYearSelect = document.getElementById('monthYear');
			monthYears.forEach(my => {
				if (my) {
					const option = document.createElement('option');
					option.value = my;
					option.textContent = my;
					monthYearSelect.appendChild(option);
				}
			});

			// Populate year dropdown
			const years = [...new Set(allData.map(row => row.year))].filter(y => y > 0).sort((a,b) => b-a);
			const yearSelect = document.getElementById('year');
			years.forEach(year => {
				const option = document.createElement('option');
				option.value = year;
				option.textContent = year;
				yearSelect.appendChild(option);
			});

			// Populate cluster dropdown
			const clusters = [...new Set(allData.map(row => row.cluster))].filter(c => c).sort();
			const clusterSelect = document.getElementById('cluster');
			clusters.forEach(cluster => {
				const option = document.createElement('option');
				option.value = cluster;
				option.textContent = cluster;
				clusterSelect.appendChild(option);
			});
		}

		function applyFilters() {
			const durationType = document.getElementById('durationType').value;
			const selectedMonthYear = document.getElementById('monthYear').value;
			const selectedQuarter = document.getElementById('quarter').value;
			const selectedYear = document.getElementById('year').value;
			const selectedCluster = document.getElementById('cluster').value;

			// Filter data based on selections
			let filtered = allData.filter(row => {
				if (selectedCluster && row.cluster !== selectedCluster) return false;
				
				if (durationType === 'month' && selectedMonthYear && row.monthYear !== selectedMonthYear) return false;
				
				if (durationType === 'quarter') {
					if (selectedYear && row.year != selectedYear) return false;
					if (selectedQuarter && getQuarter(row.monthIndex) !== selectedQuarter) return false;
				}

				if (durationType === 'year' && selectedYear && row.year != selectedYear) return false;
				
				return true;
			});

			// Aggregate data by university
			const aggregated = {};
			filtered.forEach(row => {
				const key = row.university;
				if (!aggregated[key]) {
					aggregated[key] = {
						university: row.university,
						cluster: row.cluster,
						leads: { actual: 0, plan: 0 },
						admissions: { actual: 0, plan: 0 },
						revenue: { actual: 0, plan: 0 },
						pl: { actual: 0, plan: 0 },
						spend: { actual: 0, plan: 0 },
						cpl: { actual: 0, plan: 0 },
						cpa: { actual: 0, plan: 0 },
						roas: { actual: 0, plan: 0 },
						convRate: { actual: 0, plan: 0 },
						count: 0
					};
				}
				
				const agg = aggregated[key];
				['leads', 'admissions', 'revenue', 'pl', 'spend', 'cpl', 'cpa', 'roas', 'convRate'].forEach(metric => {
					agg[metric].actual += row[metric].actual;
					agg[metric].plan += row[metric].plan;
				});
				agg.count++;
			});

			// Calculate averages for CPL, CPA, ROAS, Conv Rate
			Object.values(aggregated).forEach(row => {
				['cpl', 'cpa', 'roas', 'convRate'].forEach(metric => {
					row[metric].actual = row[metric].actual / row.count;
					row[metric].plan = row[metric].plan / row.count;
				});
			});

			filteredData = Object.values(aggregated);
			renderTable();
		}

		function calculateVariance(actual, plan) {
			if (plan === 0) return 0;
			return ((actual - plan) / plan) * 100;
		}

		function formatVariance(variance) {
			const rounded = Math.round(variance * 10) / 10;
			if (variance > 0) {
				return `<span class="variance positive">↗ +${rounded}%</span>`;
			} else if (variance < 0) {
				return `<span class="variance negative">↘ ${rounded}%</span>`;
			} else {
				return `<span class="variance neutral">↔ 0%</span>`;
			}
		}

		function formatNumber(num) {
			return Math.round(num).toLocaleString('en-IN');
		}

		function formatCurrency(num) {
			const rounded = Math.round(num);
			if (rounded >= 100000) {
				return `₹${(rounded / 1000).toFixed(0)}k`;
			}
			return `₹${rounded.toLocaleString('en-IN')}`;
		}

		function formatPercentage(num) {
			return `${num.toFixed(1)}%`;
		}

		function createMetricCell(actual, plan, format = 'number') {
			const variance = calculateVariance(actual, plan);
			let actualDisplay, planDisplay;
			
			if (format === 'currency') {
				actualDisplay = formatCurrency(actual);
				planDisplay = formatCurrency(plan);
			} else if (format === 'percentage') {
				actualDisplay = formatPercentage(actual);
				planDisplay = formatPercentage(plan);
			} else if (format === 'decimal') {
				actualDisplay = actual.toFixed(1);
				planDisplay = plan.toFixed(1);
			} else {
				actualDisplay = formatNumber(actual);
				planDisplay = formatNumber(plan);
			}
			
			return `
				<div class="metric-cell">
					<span class="actual-value">${actualDisplay}</span>
					<span class="plan-value">Plan: ${planDisplay}</span>
					${formatVariance(variance)}
				</div>
			`;
		}

		function getROASClass(actual, revised) {
			if (revised === 0) return '';
			if (actual >= revised) return 'green';
			const drop = (revised - actual) / revised;
			if (drop <= 0.2) return 'amber';
			return 'red';
		}

		function renderTable() {
			const container = document.getElementById('tableContainer');
			
			if (filteredData.length === 0) {
				container.innerHTML = '<div class="loading">No data available for selected filters</div>';
				return;
			}

			let html = `
				<table>
					<thead>
						<tr>
							<th>University</th>
							<th>Leads</th>
							<th>Admissions</th>
							<th>Spend</th>
							<th>Revenue</th>
							<th>CPL</th>
							<th>P&L</th>
							<th>ROAS ⭐</th>
						</tr>
					</thead>
					<tbody>
			`;
			
			// Totals calculation (only displayed metrics)
			const totals = {
				leads: { actual: 0, plan: 0 },
				admissions: { actual: 0, plan: 0 },
				spend: { actual: 0, plan: 0 },
				revenue: { actual: 0, plan: 0 },
				cpl: { actual: 0, plan: 0 },
				pl: { actual: 0, plan: 0 },
				roas: { actual: 0, plan: 0 }
			};
			
			filteredData.forEach(row => {
				const roasClass = getROASClass(row.roas.actual, row.roas.plan);
				
				html += `
					<tr>
						<td>${row.university}</td>
						<td>${createMetricCell(row.leads.actual, row.leads.plan)}</td>
						<td>${createMetricCell(row.admissions.actual, row.admissions.plan)}</td>
						<td>${createMetricCell(row.spend.actual, row.spend.plan, 'currency')}</td>
						<td>${createMetricCell(row.revenue.actual, row.revenue.plan, 'currency')}</td>
						<td>${createMetricCell(row.cpl.actual, row.cpl.plan, 'currency')}</td>
						<td>${createMetricCell(row.pl.actual, row.pl.plan, 'currency')}</td>
						<td class="roas-cell ${roasClass}">
							${createMetricCell(row.roas.actual, row.roas.plan, 'decimal')}
						</td>
					</tr>
				`;
				
				// Accumulate totals
				Object.keys(totals).forEach(key => {
					totals[key].actual += row[key].actual;
					totals[key].plan += row[key].plan;
				});
			});
			
			// Calculate averages for CPL and ROAS
			const rowCount = filteredData.length;
			['cpl', 'roas'].forEach(key => {
				totals[key].actual = totals[key].actual / rowCount;
				totals[key].plan = totals[key].plan / rowCount;
			});
			
			const totalRoasClass = getROASClass(totals.roas.actual, totals.roas.plan);
			
			// Add totals row
			html += `
				<tr class="total-row">
					<td>Total</td>
					<td>${createMetricCell(totals.leads.actual, totals.leads.plan)}</td>
					<td>${createMetricCell(totals.admissions.actual, totals.admissions.plan)}</td>
					<td>${createMetricCell(totals.spend.actual, totals.spend.plan, 'currency')}</td>
					<td>${createMetricCell(totals.revenue.actual, totals.revenue.plan, 'currency')}</td>
					<td>${createMetricCell(totals.cpl.actual, totals.cpl.plan, 'currency')}</td>
					<td>${createMetricCell(totals.pl.actual, totals.pl.plan, 'currency')}</td>
					<td class="roas-cell ${totalRoasClass}">
						${createMetricCell(totals.roas.actual, totals.roas.plan, 'decimal')}
					</td>
				</tr>
			`;
			
			html += '</tbody></table>';
			container.innerHTML = html;
		}

		// Initialize on load
		window.addEventListener('DOMContentLoaded', function() {
			fetchSheetData();
		});
	</script>
</body>
</html>
